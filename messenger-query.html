<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Mensajero - Llevo</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Local CSS -->
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Import Firebase configuration
        import { firebaseConfig } from './firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.db = db;
        window.FirebaseSDK = {
            collection,
            getDocs,
            query,
            where
        };
    </script>
</head>
<body class="min-h-screen bg-gray-100">
    <div id="app-root" class="w-full">
        <div class="dashboard-container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="flex items-center">
                    <img src="https://llevo.com.co/img/meetup-logo.png" alt="Llevo Logo" class="llevo-logo" style="max-height: 40px; margin-right: 1rem;">
                    <h1 class="text-xl font-bold text-gray-800">Consulta de Saldo</h1>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <!-- Consulta por Celular Card -->
                <div class="stat-card mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Consulta tu Saldo</h2>
                    
                    <div class="mb-4">
                        <label for="phone-input" class="block text-base font-semibold text-gray-700 mb-2">
                            üì± Ingresa tu n√∫mero de celular:
                        </label>
                        <input
                            type="tel"
                            id="phone-input"
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-llevo-secondary transition duration-200 ease-in-out bg-white"
                            placeholder="Ej: 300 123 4567"
                            maxlength="13"
                        />
                    </div>
                    
                    <button
                        id="query-button"
                        class="w-full btn-llevo-secondary p-3 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                    >
                        üîç Consultar Saldo
                    </button>
                </div>

                <!-- Resultado de la Consulta -->
                <div id="query-result" class="hidden">
                    <!-- El contenido se generar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state variables
        let currentMessenger = null;
        let servicesHistory = [];
        let topupsHistory = [];

        // DOM elements
        const phoneInput = document.getElementById('phone-input');
        const queryButton = document.getElementById('query-button');
        const queryResult = document.getElementById('query-result');

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function getFormattedDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Query Functions
        async function queryMessengerByPhone(phoneNumber) {
            try {
                // Limpiar el n√∫mero de tel√©fono
                const cleanPhone = phoneNumber.replace(/\s/g, '');
                
                // Buscar mensajero por n√∫mero de celular
                const q = FirebaseSDK.query(
                    FirebaseSDK.collection(db, 'messengers'),
                    FirebaseSDK.where('phoneNumber', '==', cleanPhone)
                );
                
                const querySnapshot = await FirebaseSDK.getDocs(q);
                
                if (querySnapshot.empty) {
                    return null;
                }
                
                const messengerDoc = querySnapshot.docs[0];
                return { id: messengerDoc.id, ...messengerDoc.data() };
            } catch (error) {
                console.error('Error querying messenger:', error);
                throw error;
            }
        }

        async function loadMessengerHistory(messengerId) {
            try {
                // Cargar servicios
                const servicesQuery = FirebaseSDK.query(
                    FirebaseSDK.collection(db, 'services'),
                    FirebaseSDK.where('messengerId', '==', messengerId)
                );
                const servicesSnapshot = await FirebaseSDK.getDocs(servicesQuery);
                servicesHistory = [];
                servicesSnapshot.forEach((doc) => {
                    servicesHistory.push({ id: doc.id, ...doc.data() });
                });
                
                // Cargar recargas
                const topupsQuery = FirebaseSDK.query(
                    FirebaseSDK.collection(db, 'topups'),
                    FirebaseSDK.where('messengerId', '==', messengerId)
                );
                const topupsSnapshot = await FirebaseSDK.getDocs(topupsQuery);
                topupsHistory = [];
                topupsSnapshot.forEach((doc) => {
                    topupsHistory.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordenar por fecha
                servicesHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                topupsHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            } catch (error) {
                console.error('Error loading history:', error);
                throw error;
            }
        }

        function calculateBalance() {
            let balance = 0;
            
            // Sumar recargas
            topupsHistory.forEach(topup => {
                balance += topup.amount;
            });
            
            // Restar servicios
            servicesHistory.forEach(service => {
                balance -= service.amount;
            });
            
            return balance;
        }

        function renderQueryResult() {
            if (!currentMessenger) {
                queryResult.innerHTML = `
                    <div class="bg-red-50 p-4 rounded-xl border border-red-200 mb-6">
                        <p class="text-red-800 text-center">No se encontr√≥ un mensajero con ese n√∫mero de celular.</p>
                    </div>
                `;
                queryResult.classList.remove('hidden');
                return;
            }

            const balance = calculateBalance();
            
            queryResult.innerHTML = `
                <div class="stat-card mb-6">
                    <!-- Messenger Info Card -->
                    <div class="messenger-card mb-6" style="cursor: default;">
                        <div class="messenger-card-header">
                            <div class="messenger-avatar">
                                ${currentMessenger.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="messenger-info">
                                <h3 class="messenger-name">${currentMessenger.name}</h3>
                                ${currentMessenger.phoneNumber ? `<p class="messenger-phone">üì± ${currentMessenger.phoneNumber}</p>` : ''}
                            </div>
                        </div>
                        
                        <!-- Saldo Actual -->
                        <div class="messenger-balance">
                            <div class="balance-label">Saldo Actual</div>
                            <div class="balance-amount ${balance < 0 ? 'negative' : balance < 5000 ? 'low' : 'positive'}">${formatCurrency(balance)}</div>
                        </div>
                        
                        <!-- Status Badge -->
                        <div class="messenger-stats">
                            <div class="stat-item">
                                <span class="stat-value">${servicesHistory.length}</span>
                                <span class="stat-label">Servicios</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${topupsHistory.length}</span>
                                <span class="stat-label">Recargas</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alertas de Saldo -->
                    ${balance < 0 ? `
                        <div class="stat-card mb-4" style="background: #fef2f2; border-color: #fecaca;">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">üö®</span>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-red-800 font-semibold text-lg mb-2">¬°Atenci√≥n Cr√≠tica!</h4>
                                    <p class="text-red-700 text-base mb-2">Es necesario que hagas una recarga para poder seguir recibiendo servicios.</p>
                                    <p class="text-red-600 text-sm">üí° <strong>Recomendaci√≥n:</strong> Recarga m√≠nimo $10.000 para salir del saldo negativo.</p>
                                </div>
                            </div>
                        </div>
                    ` : balance < 5000 ? `
                        <div class="stat-card mb-4" style="background: #fffbeb; border-color: #fde68a;">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">‚ö†Ô∏è</span>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-orange-800 font-semibold text-lg mb-2">Saldo Bajo</h4>
                                    <p class="text-orange-700 text-base mb-2">Sr. mensajero, su saldo est√° a punto de agotarse. Lo invitamos a recargar.</p>
                                    <p class="text-orange-600 text-sm">üí° <strong>Recomendaci√≥n:</strong> Recarga m√≠nimo $5.000 para mantener un saldo saludable.</p>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="stat-card mb-4" style="background: #f0fdf4; border-color: #bbf7d0;">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <span class="text-2xl">‚úÖ</span>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-green-800 font-semibold text-lg mb-2">Saldo Saludable</h4>
                                    <p class="text-green-700 text-base">¬°Excelente! Tu saldo est√° en un nivel √≥ptimo para recibir servicios.</p>
                                </div>
                            </div>
                        </div>
                    `}

                    <!-- Historial de Movimientos -->
                    <div class="stat-card">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">üìä Historial de Movimientos</h4>
                        
                        ${servicesHistory.length === 0 && topupsHistory.length === 0 ? `
                            <p class="text-gray-500 text-center py-4">No hay movimientos registrados.</p>
                        ` : `
                            <!-- Servicios -->
                            ${servicesHistory.length > 0 ? `
                                <div class="mb-6">
                                    <h5 class="text-base font-semibold mb-3 text-llevo-secondary">üíº Servicios Prestados</h5>
                                    <div class="space-y-2">
                                        ${servicesHistory.map(service => `
                                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-1">
                                                        <p class="text-sm font-semibold text-gray-800">${service.description}</p>
                                                        <p class="text-xs text-gray-500 mt-1">${getFormattedDate(service.date)}</p>
                                                        ${service.totalAmount ? `<p class="text-xs text-gray-500">Valor total: ${formatCurrency(service.totalAmount)}</p>` : ''}
                                                    </div>
                                                    <span class="text-llevo-secondary font-bold">-${formatCurrency(service.amount)}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Recargas -->
                            ${topupsHistory.length > 0 ? `
                                <div>
                                    <h5 class="text-base font-semibold mb-3 text-llevo-primary">üí≥ Recargas Realizadas</h5>
                                    <div class="space-y-2">
                                        ${topupsHistory.map(topup => `
                                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-1">
                                                        <p class="text-sm font-semibold text-gray-800">Recarga de saldo</p>
                                                        <p class="text-xs text-gray-500 mt-1">${getFormattedDate(topup.date)}</p>
                                                    </div>
                                                    <span class="text-llevo-primary font-bold">+${formatCurrency(topup.amount)}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        `}
                    </div>

                    <!-- Bot√≥n para nueva consulta -->
                    <button
                        id="new-query-button"
                        class="w-full btn-llevo-secondary p-3 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200 mt-4"
                    >
                        üîç Nueva Consulta
                    </button>
                </div>
            `;
            
            queryResult.classList.remove('hidden');
            
            // Attach event listener for new query button
            const newQueryButton = document.getElementById('new-query-button');
            if (newQueryButton) {
                newQueryButton.addEventListener('click', () => {
                    resetQuery();
                });
            }
        }

        function resetQuery() {
            currentMessenger = null;
            servicesHistory = [];
            topupsHistory = [];
            phoneInput.value = '';
            queryResult.classList.add('hidden');
            phoneInput.focus();
        }

        // Event Listeners
        queryButton.addEventListener('click', async () => {
            const phoneNumber = phoneInput.value.trim();
            
            if (!phoneNumber) {
                alert('Por favor, ingresa tu n√∫mero de celular.');
                return;
            }
            
            // Validar formato de celular
            const cleanPhone = phoneNumber.replace(/\s/g, '');
            if (cleanPhone.length < 10 || cleanPhone.length > 13) {
                alert('El n√∫mero de celular debe tener entre 10 y 13 d√≠gitos.');
                return;
            }
            
            try {
                queryButton.disabled = true;
                queryButton.textContent = 'üîç Consultando...';
                
                // Buscar mensajero
                currentMessenger = await queryMessengerByPhone(cleanPhone);
                
                if (currentMessenger) {
                    // Cargar historial
                    await loadMessengerHistory(currentMessenger.id);
                }
                
                // Mostrar resultado
                renderQueryResult();
                
            } catch (error) {
                console.error('Error in query:', error);
                alert('Error al consultar. Por favor, intenta de nuevo.');
            } finally {
                queryButton.disabled = false;
                queryButton.textContent = 'üîç Consultar Saldo';
            }
        });

        // Permitir consulta con Enter
        phoneInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                queryButton.click();
            }
        });

        // Formatear n√∫mero de tel√©fono mientras se escribe
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                // Formatear como n√∫mero colombiano
                if (value.length <= 3) {
                    value = value;
                } else if (value.length <= 6) {
                    value = value.slice(0, 3) + ' ' + value.slice(3);
                } else if (value.length <= 10) {
                    value = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6);
                } else {
                    value = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6, 10) + ' ' + value.slice(10);
                }
            }
            e.target.value = value;
        });
    </script>
</body>
</html>
