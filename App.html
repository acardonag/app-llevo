<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Mensajeros (Firebase)</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Local CSS -->
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Import Firebase configuration
        import { firebaseConfig, ADMIN_USERS } from './firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.FirebaseSDK = {
            collection,
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            doc,
            query,
            where,
            orderBy
        };
        // Make Auth functions available globally
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.googleProvider = googleProvider;
        // Make ADMIN_USERS available globally
        window.ADMIN_USERS = ADMIN_USERS;
    </script>
</head>
<body class="min-h-screen p-2 sm:p-4 flex flex-col items-center bg-llevo-primary">

    <div id="app-root" class="w-full max-w-md mx-auto px-4 sm:px-6">
        <!-- Content will be rendered here by JavaScript -->
        <div class="flex items-center justify-center min-h-screen bg-llevo-primary p-4">
            <p class="text-xl text-gray-800">Cargando aplicación...</p>
        </div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4 text-center">
            <p id="modal-message" class="text-base sm:text-lg font-semibold text-gray-800 mb-4"></p>
            <div id="modal-input-container" class="mb-4 hidden">
                <label for="modal-input" id="modal-input-label" class="block text-sm font-medium text-gray-700 mb-1 text-left"></label>
                <input
                    type="text"
                    id="modal-input"
                    class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary"
                    placeholder=""
                />
            </div>
            <div id="modal-buttons" class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="modal-confirm-button" class="btn-llevo-primary px-6 py-2 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-llevo-primary focus:ring-offset-2 transition duration-200 hidden">
                    Sí
                </button>
                <button id="modal-accept-button" class="btn-llevo-secondary px-6 py-2 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200 hidden">
                    Aceptar
                </button>
                <button id="modal-close-button" class="btn-llevo-secondary px-6 py-2 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state variables
        let messengers = [];
        let selectedMessengerId = '';
        let selectedMessenger = null;
        let servicesHistory = [];
        let topupsHistory = [];
        let errorMessage = '';
        let isInitialized = false;
        let currentUser = null;
        let isProcessing = false; // Prevent duplicate transactions

        // Local Storage Keys
        const STORAGE_KEYS = {
            MESSENGERS: 'llevo_messengers',
            SERVICES: 'llevo_services',
            TOPUPS: 'llevo_topups',
            USER_ID: 'llevo_user_id'
        };

        // DOM elements
        const appRoot = document.getElementById('app-root');
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalInputContainer = document.getElementById('modal-input-container');
        const modalInput = document.getElementById('modal-input');
        const modalInputLabel = document.getElementById('modal-input-label');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalAcceptButton = document.getElementById('modal-accept-button');
        const modalCloseButton = document.getElementById('modal-close-button');

        let currentModalOnConfirm = null;
        let currentModalOnInputSubmit = null;

        // --- Modal Functions ---
        function showModal(type, message, onAction = null, inputPlaceholder = '', inputLabel = '') {
            modalMessage.textContent = message;
            modalInputContainer.classList.add('hidden');
            modalConfirmButton.classList.add('hidden');
            modalAcceptButton.classList.add('hidden');
            modalCloseButton.textContent = 'Cerrar';

            if (type === 'confirm') {
                modalConfirmButton.classList.remove('hidden');
                modalCloseButton.textContent = 'No';
                currentModalOnConfirm = onAction;
            } else if (type === 'input') {
                modalInputContainer.classList.remove('hidden');
                modalInput.placeholder = inputPlaceholder;
                modalInputLabel.textContent = inputLabel;
                modalInput.value = ''; // Clear previous input
                modalAcceptButton.classList.remove('hidden');
                currentModalOnInputSubmit = onAction;
            } else { // 'message'
                modalCloseButton.textContent = 'Cerrar';
            }
            customModal.classList.remove('hidden');
        }

        function closeModal() {
            customModal.classList.add('hidden');
            currentModalOnConfirm = null;
            currentModalOnInputSubmit = null;
        }

        // Event listeners for modal buttons
        modalCloseButton.addEventListener('click', closeModal);
        modalConfirmButton.addEventListener('click', () => {
            if (currentModalOnConfirm) currentModalOnConfirm();
            closeModal();
        });
        modalAcceptButton.addEventListener('click', () => {
            if (currentModalOnInputSubmit) currentModalOnInputSubmit(modalInput.value);
            closeModal();
        });

        // --- Utility Functions ---
        function getFormattedDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleDateString('es-CO', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Función para formatear valores en pesos colombianos
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Función para formatear números mientras se escriben (con separadores de miles)
        function formatNumberInput(input) {
            // Guardar la posición del cursor
            const cursorPosition = input.selectionStart;
            
            // Obtener solo los números del input
            let value = input.value.replace(/[^\d]/g, '');
            
            // Si no hay valor, limpiar el input
            if (value === '') {
                input.value = '';
                input.classList.remove('formatted');
                return;
            }
            
            // Convertir a número y formatear con separadores de miles
            const number = parseInt(value, 10);
            const formatted = new Intl.NumberFormat('es-CO').format(number);
            
            // Actualizar el valor del input
            input.value = formatted;
            input.classList.add('formatted');
            
            // Calcular nueva posición del cursor considerando los separadores agregados
            // Intentar mantener el cursor en una posición lógica
            let newCursorPosition = cursorPosition;
            
            // Si el cursor está al final, mantenerlo al final
            if (cursorPosition >= input.value.length - 1) {
                newCursorPosition = formatted.length;
            } else {
                // Calcular la nueva posición considerando los separadores
                const beforeCursor = input.value.substring(0, cursorPosition);
                const digitsBeforeCursor = beforeCursor.replace(/[^\d]/g, '').length;
                
                // Encontrar la posición en el texto formateado que corresponde a esos dígitos
                let currentDigits = 0;
                for (let i = 0; i < formatted.length; i++) {
                    if (/\d/.test(formatted[i])) {
                        currentDigits++;
                        if (currentDigits === digitsBeforeCursor) {
                            newCursorPosition = i + 1;
                            break;
                        }
                    }
                }
            }
            
            // Asegurar que la posición del cursor sea válida
            newCursorPosition = Math.min(Math.max(0, newCursorPosition), formatted.length);
            input.setSelectionRange(newCursorPosition, newCursorPosition);
        }

        // Función para obtener el valor numérico de un input formateado
        function getNumericValue(formattedValue) {
            return parseInt(formattedValue.replace(/[^\d]/g, ''), 10);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Function to recalculate messenger balance based on all transactions
        function recalculateMessengerBalance(messengerId) {
            if (!messengerId) return 0;
            
            const totalServices = servicesHistory.reduce((sum, service) => sum + service.amount, 0);
            const totalTopups = topupsHistory.reduce((sum, topup) => sum + topup.amount, 0);
            
            // Base balance starts at 0, so final balance = totalTopups - totalServices
            return totalTopups - totalServices;
        }

        // Function to clear all forms
        function clearForms() {
            const serviceDescriptionInput = document.getElementById('service-description');
            const serviceAmountInput = document.getElementById('service-amount');
            const topupAmountInput = document.getElementById('topup-amount');
            
            if (serviceDescriptionInput) serviceDescriptionInput.value = '';
            if (serviceAmountInput) {
                serviceAmountInput.value = '';
                serviceAmountInput.classList.remove('formatted');
            }
            if (topupAmountInput) {
                topupAmountInput.value = '';
                topupAmountInput.classList.remove('formatted');
            }
        }

        // Safety function to reset processing state
        function resetProcessingState() {
            isProcessing = false;
        }

        // Safety timeout to prevent stuck processing state
        function setProcessingTimeout() {
            setTimeout(() => {
                if (isProcessing) {
                    console.warn('Processing timeout reached, resetting state');
                    isProcessing = false;
                    renderApp();
                }
            }, 10000); // 10 seconds timeout
        }

        // --- Authentication Functions ---
        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                
                // Verificar si el usuario es administrador
                if (!ADMIN_USERS.includes(user.email)) {
                    showModal('message', `Acceso denegado. El usuario ${user.email} no está autorizado como administrador.`);
                    await signOut(auth);
                    return false;
                }
                
                currentUser = user;
                showModal('message', `Bienvenido ${user.displayName || user.email}! Acceso autorizado como administrador.`);
                return true;
            } catch (error) {
                console.error('Error signing in with Google:', error);
                showModal('message', 'Error al iniciar sesión con Google.');
                return false;
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                currentUser = null;
                messengers = [];
                selectedMessengerId = '';
                selectedMessenger = null;
                servicesHistory = [];
                topupsHistory = [];
                showModal('message', 'Sesión cerrada exitosamente.');
                renderApp();
            } catch (error) {
                console.error('Error signing out:', error);
                showModal('message', 'Error al cerrar sesión.');
            }
        }

        // --- Firebase Functions ---
        async function saveToFirebase(collectionName, data, documentId = null) {
            try {
                // Agregar información de quién hizo la modificación
                const modificationData = {
                    ...data,
                    lastModifiedBy: currentUser.uid,
                    lastModifiedByEmail: currentUser.email,
                    lastModifiedByName: currentUser.displayName || currentUser.email,
                    lastModifiedAt: new Date().toISOString()
                };

                if (documentId) {
                    // Update existing document
                    const docRef = FirebaseSDK.doc(db, collectionName, documentId);
                    await FirebaseSDK.updateDoc(docRef, modificationData);
                } else {
                    // Add new document
                    await FirebaseSDK.addDoc(FirebaseSDK.collection(db, collectionName), modificationData);
                }
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                showModal('message', 'Error al guardar datos en Firebase.');
                throw error;
            }
        }

        async function loadFromFirebase(collectionName, userId = null) {
            try {
                let q;
                if (userId) {
                    q = FirebaseSDK.query(
                        FirebaseSDK.collection(db, collectionName),
                        FirebaseSDK.where('userId', '==', userId)
                    );
                } else {
                    q = FirebaseSDK.query(FirebaseSDK.collection(db, collectionName));
                }
                
                const querySnapshot = await FirebaseSDK.getDocs(q);
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                return data;
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                showModal('message', 'Error al cargar datos de Firebase.');
                return [];
            }
        }

        async function deleteFromFirebase(collectionName, documentId) {
            try {
                // Antes de eliminar, guardar información de quién hizo la eliminación
                // Primero obtenemos el documento para guardar la información de eliminación
                const docRef = FirebaseSDK.doc(db, collectionName, documentId);
                const docSnap = await FirebaseSDK.getDocs(FirebaseSDK.query(
                    FirebaseSDK.collection(db, `${collectionName}_deleted`),
                    FirebaseSDK.where('originalId', '==', documentId)
                ));
                
                // Si no existe un registro de eliminación, lo creamos
                if (docSnap.empty) {
                    await FirebaseSDK.addDoc(FirebaseSDK.collection(db, `${collectionName}_deleted`), {
                        originalId: documentId,
                        deletedBy: currentUser.uid,
                        deletedByEmail: currentUser.email,
                        deletedByName: currentUser.displayName || currentUser.email,
                        deletedAt: new Date().toISOString(),
                        collectionName: collectionName
                    });
                }
                
                // Ahora eliminamos el documento original
                await FirebaseSDK.deleteDoc(docRef);
            } catch (error) {
                console.error('Error deleting from Firebase:', error);
                showModal('message', 'Error al eliminar datos de Firebase.');
                throw error;
            }
        }

        // --- Data Management Functions ---
        async function loadMessengers() {
            try {
                // Cargar todos los mensajeros sin filtrar por usuario para que todos los administradores vean la misma información
                messengers = await loadFromFirebase('messengers');
                renderApp();
            } catch (error) {
                console.error('Error loading messengers:', error);
                messengers = [];
                renderApp();
            }
        }

        async function saveMessenger(messenger) {
            try {
                if (messenger.id && messenger.id.length > 20) {
                    // This is a Firebase document ID, update existing
                    await saveToFirebase('messengers', messenger, messenger.id);
                } else {
                    // This is a new messenger, add to Firebase
                    const docRef = await FirebaseSDK.addDoc(FirebaseSDK.collection(db, 'messengers'), {
                        ...messenger,
                        // No asignar userId específico para que sea compartido entre administradores
                        createdBy: currentUser.uid,
                        createdByEmail: currentUser.email,
                        createdByName: currentUser.displayName || currentUser.email,
                        createdAt: new Date().toISOString()
                    });
                    messenger.id = docRef.id;
                }
            } catch (error) {
                console.error('Error saving messenger:', error);
                throw error;
            }
        }

        async function loadServices(messengerId) {
            try {
                // Simplified query without orderBy to avoid index requirements
                const q = FirebaseSDK.query(
                    FirebaseSDK.collection(db, 'services'),
                    FirebaseSDK.where('messengerId', '==', messengerId)
                );
                const querySnapshot = await FirebaseSDK.getDocs(q);
                servicesHistory = [];
                querySnapshot.forEach((doc) => {
                    servicesHistory.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort locally to avoid Firebase index requirements
                servicesHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                renderApp();
            } catch (error) {
                console.error('Error loading services:', error);
                servicesHistory = [];
                renderApp();
            }
        }

        async function saveService(service) {
            try {
                await saveToFirebase('services', {
                    ...service,
                    // Registrar quién creó el servicio pero no filtrar por usuario
                    createdBy: currentUser.uid,
                    createdByEmail: currentUser.email,
                    createdByName: currentUser.displayName || currentUser.email,
                    messengerId: selectedMessengerId,
                    date: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving service:', error);
                throw error;
            }
        }

        async function loadTopups(messengerId) {
            try {
                // Simplified query without orderBy to avoid index requirements
                const q = FirebaseSDK.query(
                    FirebaseSDK.collection(db, 'topups'),
                    FirebaseSDK.where('messengerId', '==', messengerId)
                );
                const querySnapshot = await FirebaseSDK.getDocs(q);
                topupsHistory = [];
                querySnapshot.forEach((doc) => {
                    topupsHistory.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort locally to avoid Firebase index requirements
                topupsHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                renderApp();
            } catch (error) {
                console.error('Error loading topups:', error);
                topupsHistory = [];
                renderApp();
            }
        }

        async function saveTopup(topup) {
            try {
                await saveToFirebase('topups', {
                    ...topup,
                    // Registrar quién creó el recarga pero no filtrar por usuario
                    createdBy: currentUser.uid,
                    createdByEmail: currentUser.email,
                    createdByName: currentUser.displayName || currentUser.email,
                    messengerId: selectedMessengerId,
                    date: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving topup:', error);
                throw error;
            }
        }

        // --- Export/Import Functions ---
        async function exportData() {
            try {
                // Load all data from Firebase (sin filtrar por usuario para que sea compartido)
                const allServices = await loadFromFirebase('services');
                const allTopups = await loadFromFirebase('topups');
                
                const exportData = {
                    messengers: messengers,
                    services: allServices,
                    topups: allTopups,
                    exportDate: new Date().toISOString(),
                    version: '2.0',
                    source: 'Firebase'
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `llevo_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showModal('message', 'Datos exportados exitosamente desde Firebase.');
            } catch (error) {
                console.error('Error exporting data:', error);
                showModal('message', 'Error al exportar los datos desde Firebase.');
            }
        }

        async function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const importData = JSON.parse(e.target.result);
                            
                            if (importData.messengers && importData.services && importData.topups) {
                                // Import messengers
                                for (const messenger of importData.messengers) {
                                    // Sin asignar userId específico para que sea compartido
                                    await saveMessenger(messenger);
                                }
                                
                                // Import services
                                for (const service of importData.services) {
                                    // Sin asignar userId específico para que sea compartido
                                    await saveService(service);
                                }
                                
                                // Import topups
                                for (const topup of importData.topups) {
                                    // Sin asignar userId específico para que sea compartido
                                    await saveTopup(topup);
                                }
                                
                                // Reload data
                                await loadMessengers();
                                
                                selectedMessengerId = '';
                                selectedMessenger = null;
                                servicesHistory = [];
                                topupsHistory = [];
                                
                                showModal('message', 'Datos importados exitosamente a Firebase.');
                                renderApp();
                            } else {
                                showModal('message', 'Formato de archivo inválido.');
                            }
                        } catch (error) {
                            console.error('Error parsing import file:', error);
                            showModal('message', 'Error al leer el archivo de importación.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }

        // --- Render Functions ---
        function renderApp() {
            if (errorMessage) {
                appRoot.innerHTML = `
                                    <div class="flex items-center justify-center min-h-screen bg-llevo-primary-light text-gray-800 p-4 rounded-xl shadow-md border border-llevo-primary-dark">
                    <p class="text-xl">${errorMessage}</p>
                </div>
                `;
                return;
            }

            if (!isInitialized) {
                appRoot.innerHTML = `
                                    <div class="flex items-center justify-center min-h-screen bg-llevo-primary p-4">
                    <p class="text-xl text-gray-800">Cargando aplicación...</p>
                </div>
                `;
                return;
            }

            appRoot.innerHTML = `
                <!-- Llevo Header with Logo -->
                <div class="llevo-header w-full text-center">
                    <img src="https://llevo.com.co/img/meetup-logo.png" alt="Llevo Logo" class="llevo-logo mx-auto mb-2">
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">Llevo</h1>
                    <p class="text-xs sm:text-sm text-gray-700">Gestión de Mensajeros</p>
                </div>

                <!-- Authentication Status -->
                ${currentUser ? `
                    <div class="w-full text-center mb-4 p-3 bg-green-100 rounded-lg shadow-sm border border-green-300">
                        <div class="flex items-center justify-center space-x-2 mb-2">
                            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-bold">${currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : currentUser.email.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="text-left">
                                <p class="text-sm font-semibold text-green-800">${currentUser.displayName || 'Usuario'}</p>
                                <p class="text-xs text-green-600">${currentUser.email}</p>
                            </div>
                        </div>
                        <button
                            id="signout-button"
                            class="btn-llevo-secondary px-4 py-2 text-sm rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                        >
                            Cerrar Sesión
                        </button>
                    </div>
                ` : `
                    <div class="w-full text-center mb-4 p-3 bg-yellow-100 rounded-lg shadow-sm border border-yellow-300">
                        <p class="text-sm text-yellow-800 mb-2">🔐 Inicia sesión para acceder a la aplicación</p>
                        <button
                            id="signin-button"
                            class="btn-llevo-primary px-6 py-2 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-llevo-primary focus:ring-offset-2 transition duration-200"
                        >
                            <svg class="w-5 h-5 inline mr-2" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Iniciar Sesión con Google
                        </button>
                    </div>
                `}

                ${currentUser ? `
                    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-xl w-full mb-6 border border-gray-200">
                        <h1 class="text-2xl sm:text-3xl font-bold mb-4 sm:mb-6 text-center text-llevo-secondary">Gestionar Mensajeros</h1>

                        <!-- Select Messenger -->
                        <div class="mb-4">
                            <label for="messenger-select" class="block text-base sm:text-lg font-semibold text-llevo-secondary mb-2">
                                Selecciona un Mensajero:
                            </label>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                                <select
                                    id="messenger-select"
                                    class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-llevo-secondary transition duration-200 ease-in-out bg-white"
                                >
                                    <option value="">-- Seleccionar --</option>
                                    ${messengers.map(m => `<option value="${m.id}" ${selectedMessengerId === m.id ? 'selected' : ''}>${m.name}${m.createdByName ? ` (Creado por: ${m.createdByName})` : ''}</option>`).join('')}
                                </select>
                                <button
                                    id="add-messenger-button"
                                    class="btn-llevo-secondary p-3 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200 ease-in-out flex items-center justify-center"
                                    title="Agregar nuevo mensajero"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                </button>
                            </div>
                        </div>
                ` : `
                    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-xl w-full mb-6 border border-gray-200">
                        <div class="text-center py-8">
                            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                            </div>
                            <h2 class="text-xl font-semibold text-gray-700 mb-2">Acceso Restringido</h2>
                            <p class="text-gray-600">Debes iniciar sesión con una cuenta de administrador para acceder a la gestión de mensajeros.</p>
                        </div>
                    </div>
                `}

                    ${selectedMessenger ? `
                        <div class="mt-6 sm:mt-8">
                            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center text-llevo-secondary">
                                Resumen de ${selectedMessenger.name}
                            </h2>
                            <div class="bg-llevo-secondary-light p-3 sm:p-4 rounded-xl shadow-inner mb-4 sm:mb-6 border border-llevo-secondary">
                                <p class="text-lg sm:text-xl font-bold text-center text-llevo-secondary">
                                    Saldo Actual: <span class="text-green-600">${formatCurrency(recalculateMessengerBalance(selectedMessengerId))}</span>
                                </p>
                                ${selectedMessenger.createdByName ? `
                                    <p class="text-sm text-center text-gray-600 mt-2">
                                        Creado por: ${selectedMessenger.createdByName}
                                        ${selectedMessenger.createdAt ? ` el ${getFormattedDate(selectedMessenger.createdAt)}` : ''}
                                    </p>
                                ` : ''}
                                ${selectedMessenger.lastModifiedByName ? `
                                    <p class="text-sm text-center text-gray-600">
                                        Última modificación por: ${selectedMessenger.lastModifiedByName}
                                        ${selectedMessenger.lastModifiedAt ? ` el ${getFormattedDate(selectedMessenger.lastModifiedAt)}` : ''}
                                    </p>
                                ` : ''}
                            </div>

                            <!-- Register Service Form -->
                            <form id="service-form" class="bg-llevo-secondary-light p-3 sm:p-5 rounded-xl shadow-md mb-4 sm:mb-6 border border-llevo-secondary">
                                <h3 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-llevo-secondary">Registrar Servicio</h3>
                                <div class="mb-4">
                                    <label for="service-description" class="block text-sm font-medium text-llevo-secondary mb-1">
                                        Descripción del Servicio:
                                    </label>
                                                                            <input
                                            type="text"
                                            id="service-description"
                                            class="w-full p-2 border border-llevo-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary"
                                            placeholder="Ej: Entrega de paquete A"
                                            required
                                        />
                                </div>
                                <div class="mb-4">
                                    <label for="service-amount" class="block text-sm font-medium text-llevo-secondary mb-1">
                                        Monto del Servicio ($):
                                    </label>
                                                                            <input
                                            type="text"
                                            id="service-amount"
                                            class="w-full p-2 border border-llevo-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary currency-input"
                                            placeholder="Ej: 15.000"
                                            required
                                        />
                                </div>
                                <button
                                    type="submit"
                                    id="service-submit-button"
                                    class="w-full btn-llevo-secondary p-3 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                                    ${isProcessing ? 'disabled' : ''}
                                >
                                    ${isProcessing ? 'Procesando...' : 'Descontar Servicio'}
                                </button>
                                ${isProcessing ? `
                                    <button
                                        type="button"
                                        onclick="resetProcessingState(); renderApp();"
                                        class="w-full mt-2 btn-llevo-secondary p-2 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                                    >
                                        Cancelar Transacción
                                    </button>
                                ` : ''}
                            </form>

                            <!-- Add Top-up Form -->
                            <form id="topup-form" class="bg-llevo-primary-light p-3 sm:p-5 rounded-xl shadow-md mb-4 sm:mb-6 border border-llevo-primary">
                                <h3 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-llevo-primary">Agregar Recarga</h3>
                                <div class="mb-4">
                                    <label for="topup-amount" class="block text-sm font-medium text-llevo-primary mb-1">
                                        Monto de la Recarga ($):
                                    </label>
                                                                            <input
                                            type="text"
                                            id="topup-amount"
                                            class="w-full p-2 border border-llevo-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-primary currency-input"
                                            placeholder="Ej: 50.000"
                                            required
                                        />
                                </div>
                                <button
                                    type="submit"
                                    id="topup-submit-button"
                                    class="w-full btn-llevo-primary p-3 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-primary focus:ring-offset-2 transition duration-200"
                                    ${isProcessing ? 'disabled' : ''}
                                >
                                    ${isProcessing ? 'Procesando...' : 'Recargar Saldo'}
                                </button>
                                ${isProcessing ? `
                                    <button
                                        type="button"
                                        onclick="resetProcessingState(); renderApp();"
                                        class="w-full mt-2 btn-llevo-secondary p-2 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                                    >
                                        Cancelar Transacción
                                    </button>
                                ` : ''}
                            </form>

                            <!-- History of Services and Top-ups -->
                            <div class="bg-white p-3 sm:p-5 rounded-xl shadow-md mb-4 sm:mb-6 border border-gray-200">
                                <h3 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-llevo-secondary">Historial de Transacciones</h3>
                                ${servicesHistory.length === 0 && topupsHistory.length === 0 ? `
                                    <p class="text-llevo-secondary">No hay transacciones registradas para este mensajero.</p>
                                ` : ''}

                                ${servicesHistory.length > 0 ? `
                                    <div class="mb-4">
                                        <h4 class="text-lg font-medium text-llevo-secondary mb-2">Servicios Prestados</h4>
                                        <ul class="list-disc pl-5 max-h-48 overflow-y-auto">
                                            ${servicesHistory.map(service => `
                                                <li class="mb-1 text-sm text-gray-700">
                                                    <span class="font-semibold">${getFormattedDate(service.date)}:</span> ${service.description} - <span class="text-llevo-secondary">-${formatCurrency(service.amount)}</span>
                                ${service.lastModifiedByName ? `<br><small class="text-gray-500">Modificado por: ${service.lastModifiedByName}</small>` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}

                                ${topupsHistory.length > 0 ? `
                                    <div>
                                        <h4 class="text-lg font-medium text-llevo-primary mb-2">Recargas Realizadas</h4>
                                        <ul class="list-disc pl-5 max-h-48 overflow-y-auto">
                                            ${topupsHistory.map(topup => `
                                                <li class="mb-1 text-sm text-gray-700">
                                                    <span class="font-semibold">${getFormattedDate(topup.date)}:</span> <span class="text-llevo-primary">+${formatCurrency(topup.amount)}</span>
                                ${topup.lastModifiedByName ? `<br><small class="text-gray-500">Modificado por: ${topup.lastModifiedByName}</small>` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Delete Messenger Button -->
                            <button
                                id="delete-messenger-button"
                                class="w-full btn-llevo-secondary p-3 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                            >
                                Eliminar Mensajero
                            </button>
                        </div>
                    ` : ''}
                </div>

                <!-- Llevo Footer with Export/Import -->
                <div class="llevo-footer w-full text-center">
                    <div class="bg-llevo-secondary-dark p-4 rounded-xl mb-3">
                        <h3 class="text-base sm:text-lg font-semibold text-white mb-3">Herramientas de Datos</h3>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                            <button
                                id="export-button"
                                class="btn-llevo-primary flex-1"
                            >
                                📤 Exportar Datos
                            </button>
                            <button
                                id="import-button"
                                class="btn-llevo-secondary flex-1"
                            >
                                📥 Importar Datos
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-white opacity-90">© 2024 Llevo - Gestión de Mensajeros</p>
                </div>
            `;

            // Attach event listeners after rendering
            attachEventListeners();
        }

        function attachEventListeners() {
            // Authentication event listeners
            const signinButton = document.getElementById('signin-button');
            if (signinButton) {
                signinButton.addEventListener('click', async () => {
                    const success = await signInWithGoogle();
                    if (success) {
                        await loadMessengers();
                        renderApp();
                    }
                });
            }

            const signoutButton = document.getElementById('signout-button');
            if (signoutButton) {
                signoutButton.addEventListener('click', signOutUser);
            }

            const messengerSelect = document.getElementById('messenger-select');
            if (messengerSelect) {
                messengerSelect.addEventListener('change', async (e) => {
                    selectedMessengerId = e.target.value;
                    selectedMessenger = messengers.find(m => m.id === selectedMessengerId) || null;
                    
                    // Clear previous history completely to avoid duplicates
                    servicesHistory = [];
                    topupsHistory = [];
                    
                    // Reset processing state when changing messenger
                    resetProcessingState();
                    
                    if (selectedMessenger) {
                        // Load fresh data for the selected messenger
                        await loadServices(selectedMessengerId);
                        await loadTopups(selectedMessengerId);
                    }
                    
                    // Render app after all data is loaded
                    renderApp();
                });
            }

            const addMessengerButton = document.getElementById('add-messenger-button');
            if (addMessengerButton) {
                addMessengerButton.addEventListener('click', handleAddMessenger);
            }

            const serviceForm = document.getElementById('service-form');
            if (serviceForm) {
                serviceForm.addEventListener('submit', handleRegisterService);
            }

            const topupForm = document.getElementById('topup-form');
            if (topupForm) {
                topupForm.addEventListener('submit', handleAddTopup);
            }

            const deleteMessengerButton = document.getElementById('delete-messenger-button');
            if (deleteMessengerButton && selectedMessenger) {
                deleteMessengerButton.addEventListener('click', () => {
                    handleDeleteMessenger(selectedMessenger.id, selectedMessenger.name);
                });
            }

            const exportButton = document.getElementById('export-button');
            if (exportButton) {
                exportButton.addEventListener('click', exportData);
            }

            const importButton = document.getElementById('import-button');
            if (importButton) {
                importButton.addEventListener('click', importData);
            }

            // Event listeners para formatear inputs de valores monetarios en tiempo real
            const serviceAmountInput = document.getElementById('service-amount');
            if (serviceAmountInput) {
                serviceAmountInput.addEventListener('input', () => formatNumberInput(serviceAmountInput));
                serviceAmountInput.addEventListener('blur', () => formatNumberInput(serviceAmountInput));
            }

            const topupAmountInput = document.getElementById('topup-amount');
            if (topupAmountInput) {
                topupAmountInput.addEventListener('input', () => formatNumberInput(topupAmountInput));
                topupAmountInput.addEventListener('blur', () => formatNumberInput(topupAmountInput));
            }
        }

        // --- Event Handlers ---
        const handleAddMessenger = () => {
            showModal(
                'input',
                'Ingrese el nombre del nuevo mensajero:',
                async (messengerName) => {
                    if (messengerName && messengerName.trim()) {
                        try {
                            const newMessenger = {
                                name: messengerName.trim(),
                                balance: 0
                            };
                            
                            await saveMessenger(newMessenger);
                            messengers.push(newMessenger);
                            showModal('message', `Mensajero '${messengerName}' agregado con éxito a Firebase.`);
                            renderApp();
                        } catch (e) {
                            console.error("Error adding messenger: ", e);
                            showModal('message', "Error al agregar el mensajero a Firebase.");
                        }
                    } else {
                        showModal('message', "El nombre del mensajero no puede estar vacío.");
                    }
                },
                'Nombre del mensajero',
                'Nombre:'
            );
        };

        const handleDeleteMessenger = (messengerId, messengerName) => {
            showModal(
                'confirm',
                `¿Estás seguro de que quieres eliminar al mensajero '${messengerName}' y todos sus datos?`,
                async () => {
                    try {
                        // Remove from messengers array
                        messengers = messengers.filter(m => m.id !== messengerId);
                        
                        // Delete from Firebase
                        await deleteFromFirebase('messengers', messengerId);
                        
                        // Delete related services and topups from Firebase
                        const servicesToDelete = servicesHistory.filter(s => s.messengerId === messengerId);
                        const topupsToDelete = topupsHistory.filter(t => t.messengerId === messengerId);
                        
                        for (const service of servicesToDelete) {
                            await deleteFromFirebase('services', service.id);
                        }
                        
                        for (const topup of topupsToDelete) {
                            await deleteFromFirebase('topups', topup.id);
                        }

                        showModal('message', `Mensajero '${messengerName}' y todos sus datos eliminados de Firebase.`);
                        if (selectedMessengerId === messengerId) {
                            selectedMessengerId = '';
                            selectedMessenger = null;
                            servicesHistory = [];
                            topupsHistory = [];
                        }
                        renderApp();
                    } catch (e) {
                        console.error("Error deleting messenger:", e);
                        showModal('message', "Error al eliminar el mensajero de Firebase.");
                    }
                }
            );
        };

        async function handleRegisterService(e) {
            e.preventDefault();
            
            // Prevent duplicate submissions
            if (isProcessing) {
                showModal('message', 'Ya se está procesando una transacción. Por favor, espere.');
                return;
            }
            
            isProcessing = true;
            setProcessingTimeout(); // Set safety timeout
            
            const serviceDescriptionInput = document.getElementById('service-description');
            const serviceAmountInput = document.getElementById('service-amount');

            if (!selectedMessengerId || !serviceDescriptionInput.value.trim() || !serviceAmountInput.value) {
                showModal('message', 'Por favor, complete todos los campos de servicio.');
                resetProcessingState();
                return;
            }

            const amount = getNumericValue(serviceAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showModal('message', 'El monto del servicio debe ser un número positivo.');
                resetProcessingState();
                return;
            }

            try {
                // Add service to Firebase first
                const newService = {
                    description: serviceDescriptionInput.value.trim(),
                    amount: amount
                };
                await saveService(newService);
                
                // Reload services to get the updated list
                await loadServices(selectedMessengerId);
                
                // Calculate new balance after reloading data
                const newBalance = recalculateMessengerBalance(selectedMessengerId);

                showModal('message', `Servicio registrado para ${selectedMessenger.name} en Firebase. Saldo actual: ${formatCurrency(newBalance)}.`);
                clearForms();
                
                // Reset processing state before rendering
                resetProcessingState();
                renderApp();
            } catch (e) {
                console.error("Error registering service: ", e);
                showModal('message', "Error al registrar el servicio en Firebase.");
                resetProcessingState();
            }
        }

        async function handleAddTopup(e) {
            e.preventDefault();
            
            // Prevent duplicate submissions
            if (isProcessing) {
                showModal('message', 'Ya se está procesando una transacción. Por favor, espere.');
                return;
            }
            
            isProcessing = true;
            setProcessingTimeout(); // Set safety timeout
            
            const topupAmountInput = document.getElementById('topup-amount');

            if (!selectedMessengerId || !topupAmountInput.value) {
                showModal('message', 'Por favor, ingrese el monto de la recarga.');
                resetProcessingState();
                return;
            }

            const amount = getNumericValue(topupAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showModal('message', 'El monto de la recarga debe ser un número positivo.');
                resetProcessingState();
                return;
            }

            try {
                // Add topup to Firebase first
                const newTopup = {
                    amount: amount
                };
                await saveTopup(newTopup);
                
                // Reload topups to get the updated list
                await loadTopups(selectedMessengerId);
                
                // Calculate new balance after reloading data
                const newBalance = recalculateMessengerBalance(selectedMessengerId);

                showModal('message', `Recarga de ${formatCurrency(amount)} agregada para ${selectedMessenger.name} en Firebase. Saldo actual: ${formatCurrency(newBalance)}.`);
                clearForms();
                
                // Reset processing state before rendering
                resetProcessingState();
                renderApp();
            } catch (e) {
                console.error("Error adding top-up: ", e);
                showModal('message', "Error al agregar la recarga en Firebase.");
                resetProcessingState();
            }
        }

        // --- Initialization ---
        window.onload = async function () {
            try {
                // Wait for Firebase to be ready
                let attempts = 0;
                while (!window.db && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.db) {
                    throw new Error('Firebase no se inicializó correctamente');
                }
                
                // Set up authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Check if user is admin
                        if (ADMIN_USERS.includes(user.email)) {
                            currentUser = user;
                            await loadMessengers();
                        } else {
                            showModal('message', `Acceso denegado. El usuario ${user.email} no está autorizado como administrador.`);
                            await signOut(auth);
                            currentUser = null;
                        }
                    } else {
                        currentUser = null;
                    }
                    
                    isInitialized = true;
                    renderApp();
                });
                
            } catch (error) {
                console.error("Error initializing application:", error);
                errorMessage = "Error al inicializar la aplicación con Firebase. Por favor, verifica tu configuración.";
                renderApp();
            }
        };
    </script>
</body>
</html>
