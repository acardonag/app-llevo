<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Mensajeros (Firebase)</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Local CSS -->
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Import Firebase configuration
        import { firebaseConfig, ADMIN_USERS } from './firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.FirebaseSDK = {
            collection,
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            doc,
            query,
            where,
            orderBy
        };
        // Make Auth functions available globally
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.googleProvider = googleProvider;
        // Make ADMIN_USERS available globally
        window.ADMIN_USERS = ADMIN_USERS;
    </script>
</head>
<body class="min-h-screen bg-gray-100">

    <div id="app-root" class="w-full">
        <!-- Content will be rendered here by JavaScript -->
        <div class="flex items-center justify-center min-h-screen bg-gray-100 p-4">
            <p class="text-xl text-gray-800">Cargando aplicaci贸n...</p>
        </div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden" style="z-index: 9999;">
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4 text-center">
            <p id="modal-message" class="text-base sm:text-lg font-semibold text-gray-800 mb-4"></p>
            <div id="modal-input-container" class="mb-4 hidden">
                <label for="modal-input" id="modal-input-label" class="block text-sm font-medium text-gray-700 mb-1 text-left"></label>
                <input
                    type="text"
                    id="modal-input"
                    class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary"
                    placeholder=""
                />
            </div>
            <div id="modal-buttons" class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="modal-confirm-button" class="btn-llevo-primary px-6 py-2 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-llevo-primary focus:ring-offset-2 transition duration-200 hidden">
                    S铆
                </button>
                <button id="modal-accept-button" class="btn-llevo-secondary px-6 py-2 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200 hidden">
                    Aceptar
                </button>
                <button id="modal-close-button" class="btn-llevo-secondary px-6 py-2 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state variables
        let messengers = [];
        let selectedMessengerId = '';
        let selectedMessenger = null;
        let servicesHistory = [];
        let topupsHistory = [];
        let errorMessage = '';
        let isInitialized = false;
        let currentUser = null;
        let isProcessing = false; // Prevent duplicate transactions
        let messengerBalances = {}; // Store balances for all messengers
        let allServices = []; // Store all services
        let allTopups = []; // Store all topups
        let allSpecialServices = []; // Store all special services

        // Local Storage Keys
        const STORAGE_KEYS = {
            MESSENGERS: 'llevo_messengers',
            SERVICES: 'llevo_services',
            TOPUPS: 'llevo_topups',
            USER_ID: 'llevo_user_id'
        };

        // DOM elements
        const appRoot = document.getElementById('app-root');
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalInputContainer = document.getElementById('modal-input-container');
        const modalInput = document.getElementById('modal-input');
        const modalInputLabel = document.getElementById('modal-input-label');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalAcceptButton = document.getElementById('modal-accept-button');
        const modalCloseButton = document.getElementById('modal-close-button');

        let currentModalOnConfirm = null;
        let currentModalOnInputSubmit = null;

        // --- Modal Functions ---
        function showModal(type, message, onAction = null, inputPlaceholder = '', inputLabel = '') {
            modalMessage.textContent = message;
            modalInputContainer.classList.add('hidden');
            modalConfirmButton.classList.add('hidden');
            modalAcceptButton.classList.add('hidden');
            modalCloseButton.textContent = 'Cerrar';

            if (type === 'confirm') {
                modalConfirmButton.classList.remove('hidden');
                modalCloseButton.textContent = 'No';
                currentModalOnConfirm = onAction;
            } else if (type === 'input') {
                modalInputContainer.classList.remove('hidden');
                modalInput.placeholder = inputPlaceholder;
                modalInputLabel.textContent = inputLabel;
                modalInput.value = ''; // Clear previous input
                modalAcceptButton.classList.remove('hidden');
                currentModalOnInputSubmit = onAction;
            } else { // 'message'
                modalCloseButton.textContent = 'Cerrar';
            }
            // Ensure modal is on top with highest z-index
            customModal.style.zIndex = '9999';
            customModal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)'; // Darker background for better visibility
            customModal.classList.remove('hidden');
        }

        function closeModal() {
            customModal.classList.add('hidden');
            currentModalOnConfirm = null;
            currentModalOnInputSubmit = null;
        }

        // Event listeners for modal buttons
        modalCloseButton.addEventListener('click', closeModal);
        modalConfirmButton.addEventListener('click', () => {
            if (currentModalOnConfirm) currentModalOnConfirm();
            closeModal();
        });
        modalAcceptButton.addEventListener('click', () => {
            if (currentModalOnInputSubmit) currentModalOnInputSubmit(modalInput.value);
            closeModal();
        });

        // --- Utility Functions ---
        function getFormattedDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleDateString('es-CO', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Function to get today's date in local timezone (YYYY-MM-DD format)
        function getTodayLocalDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to convert date string (YYYY-MM-DD) to ISO string preserving the date
        function dateStringToISO(dateString) {
            // dateString is in format YYYY-MM-DD
            // We need to create a date at midnight in local time, then convert to ISO
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day, 12, 0, 0); // Use noon to avoid timezone issues
            return date.toISOString();
        }

        // Funci贸n para formatear valores en pesos colombianos
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Funci贸n para formatear n煤meros mientras se escriben (con separadores de miles)
        function formatNumberInput(input) {
            // Guardar la posici贸n del cursor
            const cursorPosition = input.selectionStart;
            
            // Obtener solo los n煤meros del input
            let value = input.value.replace(/[^\d]/g, '');
            
            // Si no hay valor, limpiar el input
            if (value === '') {
                input.value = '';
                input.classList.remove('formatted');
                return;
            }
            
            // Convertir a n煤mero y formatear con separadores de miles
            const number = parseInt(value, 10);
            const formatted = new Intl.NumberFormat('es-CO').format(number);
            
            // Actualizar el valor del input
            input.value = formatted;
            input.classList.add('formatted');
            
            // Calcular nueva posici贸n del cursor considerando los separadores agregados
            // Intentar mantener el cursor en una posici贸n l贸gica
            let newCursorPosition = cursorPosition;
            
            // Si el cursor est谩 al final, mantenerlo al final
            if (cursorPosition >= input.value.length - 1) {
                newCursorPosition = formatted.length;
            } else {
                // Calcular la nueva posici贸n considerando los separadores
                const beforeCursor = input.value.substring(0, cursorPosition);
                const digitsBeforeCursor = beforeCursor.replace(/[^\d]/g, '').length;
                
                // Encontrar la posici贸n en el texto formateado que corresponde a esos d铆gitos
                let currentDigits = 0;
                for (let i = 0; i < formatted.length; i++) {
                    if (/\d/.test(formatted[i])) {
                        currentDigits++;
                        if (currentDigits === digitsBeforeCursor) {
                            newCursorPosition = i + 1;
                            break;
                        }
                    }
                }
            }
            
            // Asegurar que la posici贸n del cursor sea v谩lida
            newCursorPosition = Math.min(Math.max(0, newCursorPosition), formatted.length);
            input.setSelectionRange(newCursorPosition, newCursorPosition);
        }

        // Funci贸n para obtener el valor num茅rico de un input formateado
        function getNumericValue(formattedValue) {
            return parseInt(formattedValue.replace(/[^\d]/g, ''), 10);
        }

        // Funci贸n para verificar si un n煤mero de celular ya existe
        async function checkPhoneNumberExists(phoneNumber) {
            try {
                // Verificar primero en memoria local (m谩s r谩pido)
                const existingLocal = messengers.find(m => m.phoneNumber === phoneNumber);
                if (existingLocal) {
                    return { exists: true, messenger: existingLocal, source: 'local' };
                }
                
                // Verificar en Firebase para asegurar consistencia
                const q = FirebaseSDK.query(
                    FirebaseSDK.collection(db, 'messengers'),
                    FirebaseSDK.where('phoneNumber', '==', phoneNumber)
                );
                const querySnapshot = await FirebaseSDK.getDocs(q);
                
                if (!querySnapshot.empty) {
                    const existingDB = querySnapshot.docs[0].data();
                    return { exists: true, messenger: existingDB, source: 'database' };
                }
                
                return { exists: false, messenger: null, source: null };
            } catch (error) {
                console.warn('Error verificando duplicados en Firebase:', error);
                // En caso de error, solo confiamos en la validaci贸n local
                const existingLocal = messengers.find(m => m.phoneNumber === phoneNumber);
                return { 
                    exists: existingLocal !== undefined, 
                    messenger: existingLocal, 
                    source: 'local-only' 
                };
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Function to recalculate messenger balance based on all transactions
        function recalculateMessengerBalance(messengerId) {
            if (!messengerId) return 0;
            
            const totalServices = servicesHistory.reduce((sum, service) => sum + service.amount, 0);
            const totalTopups = topupsHistory.reduce((sum, topup) => sum + topup.amount, 0);
            
            // Special services are NOT associated with messengers, so they don't affect balance
            // Base balance starts at 0, so final balance = totalTopups - totalServices
            return totalTopups - totalServices;
        }

        // Function to calculate balance for a specific messenger from stored data
        function calculateMessengerBalance(messengerId) {
            if (!messengerId) return 0;
            
            const messengerServices = allServices.filter(s => s.messengerId === messengerId);
            const messengerTopups = allTopups.filter(t => t.messengerId === messengerId);
            
            const totalServices = messengerServices.reduce((sum, service) => sum + (service.amount || 0), 0);
            const totalTopups = messengerTopups.reduce((sum, topup) => sum + (topup.amount || 0), 0);
            
            // Special services are NOT associated with messengers, so they don't affect balance
            return totalTopups - totalServices;
        }

        // Function to get balance class for styling
        function getBalanceClass(balance) {
            if (balance < 0) return 'negative';
            if (balance < 5000) return 'low';
            return 'positive';
        }

        // Function to get avatar initial
        function getAvatarInitial(name) {
            if (!name) return '?';
            return name.charAt(0).toUpperCase();
        }

        // Function to load all services and topups for dashboard
        async function loadAllTransactions() {
            try {
                allServices = await loadFromFirebase('services');
                allTopups = await loadFromFirebase('topups');
                allSpecialServices = await loadFromFirebase('specialServices');
                
                // Calculate balances for all messengers
                messengerBalances = {};
                messengers.forEach(messenger => {
                    messengerBalances[messenger.id] = calculateMessengerBalance(messenger.id);
                });
            } catch (error) {
                console.error('Error loading all transactions:', error);
                allServices = [];
                allTopups = [];
                allSpecialServices = [];
            }
        }

        // Function to clear all forms
        function clearForms() {
            const serviceDescriptionInput = document.getElementById('service-description');
            const serviceAmountInput = document.getElementById('service-amount');
            const topupAmountInput = document.getElementById('topup-amount');
            
            if (serviceDescriptionInput) serviceDescriptionInput.value = '';
            if (serviceAmountInput) {
                serviceAmountInput.value = '';
                serviceAmountInput.classList.remove('formatted');
            }
            if (topupAmountInput) {
                topupAmountInput.value = '';
                topupAmountInput.classList.remove('formatted');
            }
        }

        // Safety function to reset processing state
        function resetProcessingState() {
            isProcessing = false;
        }

        // Safety timeout to prevent stuck processing state
        function setProcessingTimeout() {
            setTimeout(() => {
                if (isProcessing) {
                    console.warn('Processing timeout reached, resetting state');
                    isProcessing = false;
                    renderApp();
                }
            }, 10000); // 10 seconds timeout
        }

        // --- Authentication Functions ---
        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                
                // Verificar si el usuario es administrador
                if (!ADMIN_USERS.includes(user.email)) {
                    showModal('message', `Acceso denegado. El usuario ${user.email} no est谩 autorizado como administrador.`);
                    await signOut(auth);
                    return false;
                }
                
                currentUser = user;
                showModal('message', `Bienvenido ${user.displayName || user.email}! Acceso autorizado como administrador.`);
                return true;
            } catch (error) {
                console.error('Error signing in with Google:', error);
                showModal('message', 'Error al iniciar sesi贸n con Google.');
                return false;
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                currentUser = null;
                messengers = [];
                selectedMessengerId = '';
                selectedMessenger = null;
                servicesHistory = [];
                topupsHistory = [];
                showModal('message', 'Sesi贸n cerrada exitosamente.');
                renderApp();
            } catch (error) {
                console.error('Error signing out:', error);
                showModal('message', 'Error al cerrar sesi贸n.');
            }
        }

        // --- Firebase Functions ---
        async function saveToFirebase(collectionName, data, documentId = null) {
            try {
                // Agregar informaci贸n de qui茅n hizo la modificaci贸n
                const modificationData = {
                    ...data,
                    lastModifiedBy: currentUser.uid,
                    lastModifiedByEmail: currentUser.email,
                    lastModifiedByName: currentUser.displayName || currentUser.email,
                    lastModifiedAt: new Date().toISOString()
                };

                if (documentId) {
                    // Update existing document
                    const docRef = FirebaseSDK.doc(db, collectionName, documentId);
                    await FirebaseSDK.updateDoc(docRef, modificationData);
                } else {
                    // Add new document
                    await FirebaseSDK.addDoc(FirebaseSDK.collection(db, collectionName), modificationData);
                }
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                showModal('message', 'Error al guardar datos en Firebase.');
                throw error;
            }
        }

        async function loadFromFirebase(collectionName, userId = null) {
            try {
                let q;
                if (userId) {
                    q = FirebaseSDK.query(
                        FirebaseSDK.collection(db, collectionName),
                        FirebaseSDK.where('userId', '==', userId)
                    );
                } else {
                    q = FirebaseSDK.query(FirebaseSDK.collection(db, collectionName));
                }
                
                const querySnapshot = await FirebaseSDK.getDocs(q);
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                return data;
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                showModal('message', 'Error al cargar datos de Firebase.');
                return [];
            }
        }

        async function deleteFromFirebase(collectionName, documentId) {
            try {
                // Antes de eliminar, guardar informaci贸n de qui茅n hizo la eliminaci贸n
                // Primero obtenemos el documento para guardar la informaci贸n de eliminaci贸n
                const docRef = FirebaseSDK.doc(db, collectionName, documentId);
                const docSnap = await FirebaseSDK.getDocs(FirebaseSDK.query(
                    FirebaseSDK.collection(db, `${collectionName}_deleted`),
                    FirebaseSDK.where('originalId', '==', documentId)
                ));
                
                // Si no existe un registro de eliminaci贸n, lo creamos
                if (docSnap.empty) {
                    await FirebaseSDK.addDoc(FirebaseSDK.collection(db, `${collectionName}_deleted`), {
                        originalId: documentId,
                        deletedBy: currentUser.uid,
                        deletedByEmail: currentUser.email,
                        deletedByName: currentUser.displayName || currentUser.email,
                        deletedAt: new Date().toISOString(),
                        collectionName: collectionName
                    });
                }
                
                // Ahora eliminamos el documento original
                await FirebaseSDK.deleteDoc(docRef);
            } catch (error) {
                console.error('Error deleting from Firebase:', error);
                showModal('message', 'Error al eliminar datos de Firebase.');
                throw error;
            }
        }

        // --- Data Management Functions ---
        async function loadMessengers() {
            try {
                // Cargar todos los mensajeros sin filtrar por usuario para que todos los administradores vean la misma informaci贸n
                messengers = await loadFromFirebase('messengers');
                // Load all transactions to calculate balances
                await loadAllTransactions();
                renderApp();
            } catch (error) {
                console.error('Error loading messengers:', error);
                messengers = [];
                renderApp();
            }
        }

        async function saveMessenger(messenger) {
            try {
                // Check if messenger has a valid Firebase document ID
                // Firebase document IDs are typically 20 characters or more
                if (messenger.id && typeof messenger.id === 'string' && messenger.id.length >= 20) {
                    // This is an existing messenger, update it
                    // Remove id from the data object before saving (Firebase doesn't allow updating the document ID)
                    const { id, ...messengerData } = messenger;
                    await saveToFirebase('messengers', messengerData, id);
                } else {
                    // This is a new messenger, add to Firebase
                    // Remove id if it exists (it will be generated by Firebase)
                    const { id, ...newMessengerData } = messenger;
                    const docRef = await FirebaseSDK.addDoc(FirebaseSDK.collection(db, 'messengers'), {
                        ...newMessengerData,
                        // No asignar userId espec铆fico para que sea compartido entre administradores
                        createdBy: currentUser.uid,
                        createdByEmail: currentUser.email,
                        createdByName: currentUser.displayName || currentUser.email,
                        createdAt: new Date().toISOString()
                    });
                    messenger.id = docRef.id;
                }
            } catch (error) {
                console.error('Error saving messenger:', error);
                throw error;
            }
        }

        async function loadServices(messengerId) {
            try {
                // Simplified query without orderBy to avoid index requirements
                const q = FirebaseSDK.query(
                    FirebaseSDK.collection(db, 'services'),
                    FirebaseSDK.where('messengerId', '==', messengerId)
                );
                const querySnapshot = await FirebaseSDK.getDocs(q);
                servicesHistory = [];
                querySnapshot.forEach((doc) => {
                    servicesHistory.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort locally to avoid Firebase index requirements
                servicesHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                renderApp();
            } catch (error) {
                console.error('Error loading services:', error);
                servicesHistory = [];
                renderApp();
            }
        }

        async function saveService(service) {
            try {
                await saveToFirebase('services', {
                    ...service,
                    // Registrar qui茅n cre贸 el servicio pero no filtrar por usuario
                    createdBy: currentUser.uid,
                    createdByEmail: currentUser.email,
                    createdByName: currentUser.displayName || currentUser.email,
                    messengerId: selectedMessengerId,
                    date: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving service:', error);
                throw error;
            }
        }

        async function saveServiceWithDate(service, serviceDate) {
            try {
                await saveToFirebase('services', {
                    ...service,
                    // Registrar qui茅n cre贸 el servicio
                    createdBy: currentUser.uid,
                    createdByEmail: currentUser.email,
                    createdByName: currentUser.displayName || currentUser.email,
                    createdAt: new Date().toISOString(),
                    messengerId: selectedMessengerId,
                    date: dateStringToISO(serviceDate) // Use custom date, preserving the date value
                });
            } catch (error) {
                console.error('Error saving service:', error);
                throw error;
            }
        }

        async function loadTopups(messengerId) {
            try {
                // Simplified query without orderBy to avoid index requirements
                const q = FirebaseSDK.query(
                    FirebaseSDK.collection(db, 'topups'),
                    FirebaseSDK.where('messengerId', '==', messengerId)
                );
                const querySnapshot = await FirebaseSDK.getDocs(q);
                topupsHistory = [];
                querySnapshot.forEach((doc) => {
                    topupsHistory.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort locally to avoid Firebase index requirements
                topupsHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                renderApp();
            } catch (error) {
                console.error('Error loading topups:', error);
                topupsHistory = [];
                renderApp();
            }
        }

        async function saveTopup(topup) {
            try {
                await saveToFirebase('topups', {
                    ...topup,
                    // Registrar qui茅n cre贸 el recarga pero no filtrar por usuario
                    createdBy: currentUser.uid,
                    createdByEmail: currentUser.email,
                    createdByName: currentUser.displayName || currentUser.email,
                    messengerId: selectedMessengerId,
                    date: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving topup:', error);
                throw error;
            }
        }

        // --- Export/Import Functions ---
        async function exportData() {
            try {
                // Load all data from Firebase (sin filtrar por usuario para que sea compartido)
                const allServices = await loadFromFirebase('services');
                const allTopups = await loadFromFirebase('topups');
                
                const exportData = {
                    messengers: messengers,
                    services: allServices,
                    topups: allTopups,
                    exportDate: new Date().toISOString(),
                    version: '2.0',
                    source: 'Firebase'
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `llevo_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showModal('message', 'Datos exportados exitosamente desde Firebase.');
            } catch (error) {
                console.error('Error exporting data:', error);
                showModal('message', 'Error al exportar los datos desde Firebase.');
            }
        }

        async function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const importData = JSON.parse(e.target.result);
                            
                            if (importData.messengers && importData.services && importData.topups) {
                                // Import messengers
                                for (const messenger of importData.messengers) {
                                    // Sin asignar userId espec铆fico para que sea compartido
                                    await saveMessenger(messenger);
                                }
                                
                                // Import services
                                for (const service of importData.services) {
                                    // Sin asignar userId espec铆fico para que sea compartido
                                    await saveService(service);
                                }
                                
                                // Import topups
                                for (const topup of importData.topups) {
                                    // Sin asignar userId espec铆fico para que sea compartido
                                    await saveTopup(topup);
                                }
                                
                                // Reload data
                                await loadMessengers();
                                
                                selectedMessengerId = '';
                                selectedMessenger = null;
                                servicesHistory = [];
                                topupsHistory = [];
                                
                                showModal('message', 'Datos importados exitosamente a Firebase.');
                                renderApp();
                            } else {
                                showModal('message', 'Formato de archivo inv谩lido.');
                            }
                        } catch (error) {
                            console.error('Error parsing import file:', error);
                            showModal('message', 'Error al leer el archivo de importaci贸n.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }

        // --- Render Functions ---
        function renderApp() {
            if (errorMessage) {
                appRoot.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-llevo-primary-light text-gray-800 p-4 rounded-xl shadow-md border border-llevo-primary-dark">
                        <p class="text-xl">${errorMessage}</p>
                    </div>
                `;
                return;
            }

            if (!isInitialized) {
                appRoot.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-llevo-primary p-4">
                        <p class="text-xl text-gray-800">Cargando aplicaci贸n...</p>
                    </div>
                `;
                return;
            }

            // If user is not logged in, show login screen
            if (!currentUser) {
                appRoot.innerHTML = `
                    <div class="dashboard-container">
                        <div class="dashboard-header">
                            <div class="flex items-center">
                                <img src="https://llevo.com.co/img/meetup-logo.png" alt="Llevo Logo" class="llevo-logo" style="max-height: 40px; margin-right: 1rem;">
                                <h1 class="text-xl font-bold text-gray-800">Llevo Dashboard</h1>
                            </div>
                        </div>
                        <div class="dashboard-content">
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <div class="empty-state-text">Inicia sesi贸n para acceder al dashboard</div>
                                <div class="empty-state-subtext">Solo administradores autorizados pueden acceder</div>
                                <button
                                    id="signin-button"
                                    class="btn-llevo-primary px-6 py-3 rounded-lg font-semibold mt-4 focus:outline-none focus:ring-2 focus:ring-llevo-primary focus:ring-offset-2 transition duration-200"
                                >
                                    <svg class="w-5 h-5 inline mr-2" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    Iniciar Sesi贸n con Google
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                attachEventListeners();
                return;
            }

            // Calculate dashboard stats
            const totalMessengers = messengers.length;
            const totalBalance = Object.values(messengerBalances).reduce((sum, balance) => sum + balance, 0);
            const positiveBalances = Object.values(messengerBalances).filter(b => b > 0).length;
            const negativeBalances = Object.values(messengerBalances).filter(b => b < 0).length;
            const totalSpecialServices = allSpecialServices.reduce((sum, service) => sum + (service.cost || 0), 0);
            const totalSpecialServicesCount = allSpecialServices.length;

            appRoot.innerHTML = `
                <div class="dashboard-container">
                    <!-- Dashboard Header -->
                    <div class="dashboard-header">
                        <div class="flex items-center">
                            <img src="https://llevo.com.co/img/meetup-logo.png" alt="Llevo Logo" class="llevo-logo" style="max-height: 40px; margin-right: 1rem;">
                            <h1 class="text-xl font-bold text-gray-800">Llevo Dashboard</h1>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                                    <span class="text-white text-sm font-bold">${currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : currentUser.email.charAt(0).toUpperCase()}</span>
                                </div>
                                <div class="text-left">
                                    <p class="text-sm font-semibold text-gray-800">${currentUser.displayName || 'Usuario'}</p>
                                    <p class="text-xs text-gray-600">${currentUser.email}</p>
                                </div>
                            </div>
                            <button
                                id="signout-button"
                                class="btn-llevo-secondary px-4 py-2 text-sm rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                            >
                                Cerrar Sesi贸n
                            </button>
                        </div>
                    </div>

                    <!-- Dashboard Content -->
                    <div class="dashboard-content">
                        <!-- Stats Cards -->
                        <div class="dashboard-stats">
                            <div class="stat-card">
                                <div class="stat-card-title">Total Mensajeros</div>
                                <div class="stat-card-value">${totalMessengers}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">Saldo Total</div>
                                <div class="stat-card-value">${formatCurrency(totalBalance)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">Con Saldo Positivo</div>
                                <div class="stat-card-value">${positiveBalances}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">Con Saldo Negativo</div>
                                <div class="stat-card-value">${negativeBalances}</div>
                            </div>
                            <div class="stat-card" id="special-services-stat-card" style="border-left: 4px solid #4338ca; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                <div class="stat-card-title">Servicios Especiales</div>
                                <div class="stat-card-value" style="color: #4338ca;">${totalSpecialServicesCount}</div>
                                <div class="text-sm text-gray-600 mt-1">Total: ${formatCurrency(totalSpecialServices)}</div>
                                <div class="text-xs text-indigo-600 mt-2 font-medium"> Click para ver historial</div>
                            </div>
                        </div>

                        <!-- Action Bar -->
                        <div class="mb-4">
                            <h2 class="text-2xl font-bold text-gray-800 mb-3">Mensajeros</h2>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3">
                                <button
                                    id="register-service-button"
                                    class="btn-llevo-primary px-4 py-2 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-primary focus:ring-offset-2 transition duration-200 flex items-center justify-center"
                                >
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Registrar Servicio
                                </button>
                                <button
                                    id="register-special-service-button"
                                    class="bg-indigo-700 hover:bg-indigo-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200 flex items-center justify-center"
                                >
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                    </svg>
                                    Servicio Especial
                                </button>
                                <button
                                    id="add-messenger-button"
                                    class="btn-llevo-secondary px-4 py-2 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200 flex items-center justify-center"
                                >
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Agregar Mensajero
                                </button>
                            </div>
                        </div>

                        <!-- Messengers Grid -->
                        <div class="messenger-grid">
                            ${messengers.length === 0 ? `
                                <div class="empty-state" style="grid-column: 1 / -1;">
                                    <div class="empty-state-icon"></div>
                                    <div class="empty-state-text">No hay mensajeros registrados</div>
                                    <div class="empty-state-subtext">Haz clic en "Agregar Mensajero" para comenzar</div>
                                </div>
                            ` : messengers.map(messenger => {
                                const balance = messengerBalances[messenger.id] || 0;
                                const balanceClass = getBalanceClass(balance);
                                const messengerServices = allServices.filter(s => s.messengerId === messenger.id);
                                const messengerTopups = allTopups.filter(t => t.messengerId === messenger.id);
                                
                                return `
                                    <div class="messenger-card" data-messenger-id="${messenger.id}">
                                        <div class="messenger-card-header">
                                            <div class="messenger-avatar">
                                                ${getAvatarInitial(messenger.name)}
                                            </div>
                                            <div class="messenger-info">
                                                <h3 class="messenger-name">${messenger.name}</h3>
                                                ${messenger.phoneNumber ? `<p class="messenger-phone"> ${messenger.phoneNumber}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="messenger-balance">
                                            <div class="balance-label">Saldo Pendiente</div>
                                            <div class="balance-amount ${balanceClass}">${formatCurrency(balance)}</div>
                                        </div>
                                        <div class="messenger-stats">
                                            <div class="stat-item">
                                                <span class="stat-value">${messengerServices.length}</span>
                                                <span class="stat-label">Servicios</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-value">${messengerTopups.length}</span>
                                                <span class="stat-label">Recargas</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            
                            <!-- Add Card -->
                            <div class="messenger-card add-card" id="add-messenger-card">
                                <div class="add-card-icon">+</div>
                                <div class="add-card-text">Agregar Mensajero</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Attach event listeners after rendering
            attachEventListeners();
        }

        function attachEventListeners() {
            // Authentication event listeners
            const signinButton = document.getElementById('signin-button');
            if (signinButton) {
                signinButton.addEventListener('click', async () => {
                    const success = await signInWithGoogle();
                    if (success) {
                        await loadMessengers();
                        renderApp();
                    }
                });
            }

            const signoutButton = document.getElementById('signout-button');
            if (signoutButton) {
                signoutButton.addEventListener('click', signOutUser);
            }

            // Messenger card click listeners
            const messengerCards = document.querySelectorAll('.messenger-card[data-messenger-id]');
            messengerCards.forEach(card => {
                card.addEventListener('click', async (e) => {
                    const messengerId = card.getAttribute('data-messenger-id');
                    if (messengerId) {
                        selectedMessengerId = messengerId;
                        selectedMessenger = messengers.find(m => m.id === messengerId) || null;
                        
                        // Clear previous history
                        servicesHistory = [];
                        topupsHistory = [];
                        
                        // Reset processing state
                        resetProcessingState();
                        
                        if (selectedMessenger) {
                            // Load fresh data for the selected messenger
                            await loadServices(selectedMessengerId);
                            await loadTopups(selectedMessengerId);
                        }
                        
                        // Show messenger detail modal
                        showMessengerDetailModal();
                    }
                });
            });

            // Add messenger button listeners
            const addMessengerButton = document.getElementById('add-messenger-button');
            if (addMessengerButton) {
                addMessengerButton.addEventListener('click', handleAddMessenger);
            }

            const addMessengerCard = document.getElementById('add-messenger-card');
            if (addMessengerCard) {
                addMessengerCard.addEventListener('click', handleAddMessenger);
            }

            // Register service button listener
            const registerServiceButton = document.getElementById('register-service-button');
            if (registerServiceButton) {
                registerServiceButton.addEventListener('click', showRegisterServiceModal);
            }

            // Register special service button listener
            const registerSpecialServiceButton = document.getElementById('register-special-service-button');
            if (registerSpecialServiceButton) {
                registerSpecialServiceButton.addEventListener('click', showRegisterSpecialServiceModal);
            }

            // Special services stat card click listener (to show history)
            const specialServicesStatCard = document.getElementById('special-services-stat-card');
            if (specialServicesStatCard) {
                specialServicesStatCard.addEventListener('click', showSpecialServicesHistoryModal);
            }

            const topupForm = document.getElementById('topup-form');
            if (topupForm) {
                topupForm.addEventListener('submit', handleAddTopup);
            }

            const deleteMessengerButton = document.getElementById('delete-messenger-button');
            if (deleteMessengerButton && selectedMessenger) {
                deleteMessengerButton.addEventListener('click', () => {
                    handleDeleteMessenger(selectedMessenger.id, selectedMessenger.name);
                });
            }

            const exportButton = document.getElementById('export-button');
            if (exportButton) {
                exportButton.addEventListener('click', exportData);
            }

            const importButton = document.getElementById('import-button');
            if (importButton) {
                importButton.addEventListener('click', importData);
            }

            // Event listeners para formatear inputs de valores monetarios en tiempo real
            const serviceAmountInput = document.getElementById('service-amount');
            if (serviceAmountInput) {
                serviceAmountInput.addEventListener('input', () => formatNumberInput(serviceAmountInput));
                serviceAmountInput.addEventListener('blur', () => formatNumberInput(serviceAmountInput));
            }

            const topupAmountInput = document.getElementById('topup-amount');
            if (topupAmountInput) {
                topupAmountInput.addEventListener('input', () => formatNumberInput(topupAmountInput));
                topupAmountInput.addEventListener('blur', () => formatNumberInput(topupAmountInput));
            }
        }

        // Function to show messenger detail modal
        function showMessengerDetailModal() {
            if (!selectedMessenger) return;
            
            const balance = recalculateMessengerBalance(selectedMessengerId);
            const balanceClass = getBalanceClass(balance);
            
            const modalId = 'messenger-detail-modal-' + Date.now();
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="overflow-y: auto; z-index: 2000;">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 my-8" style="max-height: 90vh; overflow-y: auto;">
                        <div class="p-6">
                            <!-- Modal Header -->
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <div class="messenger-avatar" style="margin-right: 1rem;">
                                        ${getAvatarInitial(selectedMessenger.name)}
                                    </div>
                                    <div>
                                        <h2 class="text-2xl font-bold text-gray-800" id="messenger-name-display">${selectedMessenger.name}</h2>
                                        <p class="text-sm text-gray-600" id="messenger-phone-display"> ${selectedMessenger.phoneNumber || 'Sin tel茅fono'}</p>
                                    </div>
                                </div>
                                <button
                                    id="close-detail-modal"
                                    class="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                                    style="background: none; border: none; cursor: pointer; padding: 0.5rem;"
                                >
                                    
                                </button>
                            </div>
                            
                            <!-- Edit Messenger Info Section -->
                            <div class="stat-card mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Informaci贸n del Mensajero</h3>
                                    <button
                                        id="toggle-edit-button"
                                        class="btn-llevo-secondary px-4 py-2 text-sm rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                                    >
                                        锔 Editar
                                    </button>
                                </div>
                                
                                <div id="messenger-info-view">
                                    <div class="space-y-2">
                                        <div>
                                            <span class="text-sm font-medium text-gray-600">Nombre:</span>
                                            <p class="text-base text-gray-800" id="view-name">${selectedMessenger.name}</p>
                                        </div>
                                        <div>
                                            <span class="text-sm font-medium text-gray-600">Tel茅fono:</span>
                                            <p class="text-base text-gray-800" id="view-phone">${selectedMessenger.phoneNumber || 'Sin tel茅fono'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="messenger-info-edit" class="hidden">
                                    <form id="edit-messenger-form">
                                        <div class="mb-4">
                                            <label for="edit-messenger-name" class="block text-sm font-medium text-gray-700 mb-2">
                                                Nombre: <span class="text-red-500">*</span>
                                            </label>
                                            <input
                                                type="text"
                                                id="edit-messenger-name"
                                                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary"
                                                value="${selectedMessenger.name}"
                                                required
                                            />
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="edit-messenger-phone" class="block text-sm font-medium text-gray-700 mb-2">
                                                Tel茅fono: <span class="text-red-500">*</span>
                                            </label>
                                            <input
                                                type="tel"
                                                id="edit-messenger-phone"
                                                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary"
                                                value="${selectedMessenger.phoneNumber || ''}"
                                                placeholder="Ej: 300 123 4567"
                                                maxlength="13"
                                                required
                                            />
                                            <p class="text-xs text-gray-500 mt-1">Formato: 10-13 d铆gitos</p>
                                            <p id="phone-validation-message" class="text-xs mt-1 hidden"></p>
                                        </div>
                                        
                                        <div class="flex space-x-3">
                                            <button
                                                type="button"
                                                id="cancel-edit-button"
                                                class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-400 transition duration-200"
                                            >
                                                Cancelar
                                            </button>
                                            <button
                                                type="submit"
                                                id="save-edit-button"
                                                class="flex-1 btn-llevo-secondary px-4 py-2 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                                            >
                                                Guardar Cambios
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Balance Display -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
                                <div class="balance-label">Saldo Actual</div>
                                <div class="balance-amount ${balanceClass}" style="font-size: 2rem;">${formatCurrency(balance)}</div>
                            </div>
                            
                            <!-- Add Top-up Form -->
                            <form id="topup-form" class="bg-llevo-primary-light p-4 rounded-xl shadow-md mb-4 border border-llevo-primary">
                                <h3 class="text-lg font-semibold mb-3 text-llevo-primary">Agregar Recarga</h3>
                                <div class="mb-4">
                                    <label for="topup-amount" class="block text-sm font-medium text-llevo-primary mb-1">
                                        Monto de la Recarga ($):
                                    </label>
                                    <input
                                        type="text"
                                        id="topup-amount"
                                        class="w-full p-2 border border-llevo-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-primary currency-input"
                                        placeholder="Ej: 50.000"
                                        required
                                    />
                                </div>
                                <button
                                    type="submit"
                                    id="topup-submit-button"
                                    class="w-full btn-llevo-primary p-3 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-primary focus:ring-offset-2 transition duration-200"
                                    ${isProcessing ? 'disabled' : ''}
                                >
                                    ${isProcessing ? 'Procesando...' : 'Recargar Saldo'}
                                </button>
                            </form>
                            
                            <!-- History -->
                            <div class="bg-white p-4 rounded-xl shadow-md mb-4 border border-gray-200">
                                <h3 class="text-lg font-semibold mb-3 text-llevo-secondary">Historial de Transacciones</h3>
                                ${servicesHistory.length === 0 && topupsHistory.length === 0 ? `
                                    <p class="text-llevo-secondary">No hay transacciones registradas.</p>
                                ` : ''}
                                
                                ${servicesHistory.length > 0 ? `
                                    <div class="mb-4">
                                        <h4 class="text-base font-medium text-llevo-secondary mb-2">Servicios Prestados</h4>
                                        <ul class="list-disc pl-5 max-h-48 overflow-y-auto">
                                            ${servicesHistory.map(service => `
                                                <li class="mb-1 text-sm text-gray-700">
                                                    <span class="font-semibold">${getFormattedDate(service.date)}:</span> ${service.description} - <span class="text-llevo-secondary">-${formatCurrency(service.amount)}</span>
                                                    ${service.createdByName ? `<br><small class="text-gray-500">Registrado por: ${service.createdByName}</small>` : ''}
                                                    ${service.totalAmount ? `<br><small class="text-gray-500">Valor total: ${formatCurrency(service.totalAmount)} (descontado 20%)</small>` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${topupsHistory.length > 0 ? `
                                    <div>
                                        <h4 class="text-base font-medium text-llevo-primary mb-2">Recargas Realizadas</h4>
                                        <ul class="list-disc pl-5 max-h-48 overflow-y-auto">
                                            ${topupsHistory.map(topup => `
                                                <li class="mb-1 text-sm text-gray-700">
                                                    <span class="font-semibold">${getFormattedDate(topup.date)}:</span> <span class="text-llevo-primary">+${formatCurrency(topup.amount)}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex space-x-3">
                                <button
                                    id="delete-messenger-button"
                                    class="flex-1 btn-llevo-secondary p-3 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                                >
                                    Eliminar Mensajero
                                </button>
                                <button
                                    id="close-detail-modal-btn"
                                    class="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg font-medium hover:bg-gray-400 transition duration-200"
                                >
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById(modalId);
            
            // Close modal handlers
            const closeModal = () => {
                modal.remove();
                selectedMessengerId = '';
                selectedMessenger = null;
                servicesHistory = [];
                topupsHistory = [];
            };
            
            document.getElementById('close-detail-modal').addEventListener('click', closeModal);
            document.getElementById('close-detail-modal-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            // Delete messenger handler
            const deleteBtn = document.getElementById('delete-messenger-button');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    // Guardar los valores antes de cerrar el modal
                    if (!selectedMessenger) {
                        console.error('No hay mensajero seleccionado');
                        return;
                    }
                    const messengerId = selectedMessenger.id;
                    const messengerName = selectedMessenger.name;
                    closeModal();
                    handleDeleteMessenger(messengerId, messengerName);
                });
            }
            
            // Form handlers
            attachFormListeners(modal);
            
            // Edit messenger handlers
            attachEditMessengerHandlers(modal, modalId);
        }
        
        // Function to attach edit messenger handlers
        function attachEditMessengerHandlers(modal, modalId) {
            const toggleEditButton = modal.querySelector('#toggle-edit-button');
            const cancelEditButton = modal.querySelector('#cancel-edit-button');
            const editForm = modal.querySelector('#edit-messenger-form');
            const infoView = modal.querySelector('#messenger-info-view');
            const infoEdit = modal.querySelector('#messenger-info-edit');
            const nameInput = modal.querySelector('#edit-messenger-name');
            const phoneInput = modal.querySelector('#edit-messenger-phone');
            const phoneValidationMessage = modal.querySelector('#phone-validation-message');
            
            let isEditing = false;
            
            // Toggle edit mode
            if (toggleEditButton) {
                toggleEditButton.addEventListener('click', () => {
                    isEditing = !isEditing;
                    if (isEditing) {
                        infoView.classList.add('hidden');
                        infoEdit.classList.remove('hidden');
                        toggleEditButton.textContent = ' Cancelar';
                        toggleEditButton.classList.remove('btn-llevo-secondary');
                        toggleEditButton.classList.add('bg-gray-300', 'text-gray-700');
                        nameInput.value = selectedMessenger.name;
                        phoneInput.value = selectedMessenger.phoneNumber || '';
                        phoneInput.focus();
                    } else {
                        infoView.classList.remove('hidden');
                        infoEdit.classList.add('hidden');
                        toggleEditButton.textContent = '锔 Editar';
                        toggleEditButton.classList.add('btn-llevo-secondary');
                        toggleEditButton.classList.remove('bg-gray-300', 'text-gray-700');
                        // Reset form
                        nameInput.value = selectedMessenger.name;
                        phoneInput.value = selectedMessenger.phoneNumber || '';
                        phoneValidationMessage.classList.add('hidden');
                    }
                });
            }
            
            // Cancel edit
            if (cancelEditButton) {
                cancelEditButton.addEventListener('click', () => {
                    toggleEditButton.click(); // Toggle to view mode
                });
            }
            
            // Format phone input
            if (phoneInput) {
                phoneInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 0) {
                        if (value.length <= 3) {
                            value = value;
                        } else if (value.length <= 6) {
                            value = value.slice(0, 3) + ' ' + value.slice(3);
                        } else if (value.length <= 10) {
                            value = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6);
                        } else {
                            value = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6, 10) + ' ' + value.slice(10);
                        }
                    }
                    e.target.value = value;
                    
                    // Validate phone in real time
                    const cleanPhone = value.replace(/\s/g, '');
                    if (cleanPhone.length >= 10 && cleanPhone.length <= 13) {
                        validatePhoneForEdit(cleanPhone, phoneValidationMessage, phoneInput);
                    } else {
                        phoneValidationMessage.classList.add('hidden');
                    }
                });
            }
            
            // Form submission
            if (editForm) {
                editForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const newName = nameInput.value.trim();
                    const newPhone = phoneInput.value.trim().replace(/\s/g, '');
                    
                    if (!newName) {
                        showModal('message', 'Por favor, ingresa el nombre del mensajero.');
                        return;
                    }
                    
                    if (!newPhone) {
                        showModal('message', 'Por favor, ingresa el n煤mero de tel茅fono.');
                        return;
                    }
                    
                    if (newPhone.length < 10 || newPhone.length > 13) {
                        showModal('message', 'El n煤mero de tel茅fono debe tener entre 10 y 13 d铆gitos.');
                        return;
                    }
                    
                    // Check if phone number is already taken by another messenger
                    if (newPhone !== selectedMessenger.phoneNumber) {
                        const duplicateCheck = await checkPhoneNumberExists(newPhone);
                        if (duplicateCheck.exists && duplicateCheck.messenger.id !== selectedMessenger.id) {
                            showModal('message', `Ya existe otro mensajero con el n煤mero ${newPhone}.\n\nMensajero: ${duplicateCheck.messenger.name}`);
                            return;
                        }
                    }
                    
                    try {
                        // Update messenger - preserve the ID
                        const updatedMessenger = {
                            id: selectedMessenger.id, // Preserve the original ID
                            name: newName,
                            phoneNumber: newPhone,
                            balance: selectedMessenger.balance || 0,
                            // Preserve other fields
                            createdBy: selectedMessenger.createdBy,
                            createdByEmail: selectedMessenger.createdByEmail,
                            createdByName: selectedMessenger.createdByName,
                            createdAt: selectedMessenger.createdAt
                        };
                        
                        await saveMessenger(updatedMessenger);
                        
                        // Update local state
                        selectedMessenger = updatedMessenger;
                        const index = messengers.findIndex(m => m.id === selectedMessenger.id);
                        if (index !== -1) {
                            messengers[index] = updatedMessenger;
                        }
                        
                        // Update display
                        document.getElementById('messenger-name-display').textContent = newName;
                        document.getElementById('messenger-phone-display').textContent = ` ${newPhone}`;
                        document.getElementById('view-name').textContent = newName;
                        document.getElementById('view-phone').textContent = newPhone;
                        
                        // Update avatar initial
                        const avatar = modal.querySelector('.messenger-avatar');
                        if (avatar) {
                            avatar.textContent = getAvatarInitial(newName);
                        }
                        
                        // Exit edit mode
                        toggleEditButton.click();
                        
                        showModal('message', ' Informaci贸n del mensajero actualizada exitosamente.');
                        
                        // Reload messengers to update dashboard
                        await loadMessengers();
                        
                    } catch (error) {
                        console.error('Error updating messenger:', error);
                        showModal('message', 'Error al actualizar la informaci贸n del mensajero.');
                    }
                });
            }
        }
        
        // Function to validate phone for edit
        async function validatePhoneForEdit(phoneNumber, validationElement, phoneInput) {
            if (phoneNumber === selectedMessenger.phoneNumber) {
                validationElement.classList.add('hidden');
                phoneInput.classList.remove('border-red-500', 'border-green-500');
                return;
            }
            
            try {
                const duplicateCheck = await checkPhoneNumberExists(phoneNumber);
                if (duplicateCheck.exists && duplicateCheck.messenger.id !== selectedMessenger.id) {
                    validationElement.textContent = `锔 Este n煤mero ya est谩 registrado por: ${duplicateCheck.messenger.name}`;
                    validationElement.className = 'text-xs mt-1 text-red-600';
                    validationElement.classList.remove('hidden');
                    phoneInput.classList.add('border-red-500');
                    phoneInput.classList.remove('border-green-500');
                } else {
                    validationElement.textContent = ' N煤mero disponible';
                    validationElement.className = 'text-xs mt-1 text-green-600';
                    validationElement.classList.remove('hidden');
                    phoneInput.classList.add('border-green-500');
                    phoneInput.classList.remove('border-red-500');
                }
            } catch (error) {
                console.warn('Error validating phone:', error);
            }
        }
        
        // Function to show special services history modal
        function showSpecialServicesHistoryModal() {
            const modalId = 'special-services-history-modal-' + Date.now();
            
            // Calculate total
            const totalSpecialServices = allSpecialServices.reduce((sum, service) => sum + (service.cost || 0), 0);
            
            // Sort services by date (newest first)
            const sortedServices = [...allSpecialServices].sort((a, b) => {
                const dateA = new Date(a.date || a.createdAt);
                const dateB = new Date(b.date || b.createdAt);
                return dateB - dateA;
            });
            
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="overflow-y: auto; z-index: 1000;">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 my-8">
                        <div class="p-6">
                            <!-- Modal Header -->
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">猸 Historial de Servicios Especiales</h2>
                                <button
                                    id="close-special-services-history-modal"
                                    class="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                                    style="background: none; border: none; cursor: pointer; padding: 0.5rem;"
                                >
                                    
                                </button>
                            </div>
                            
                            <!-- Summary -->
                            <div class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="text-sm text-indigo-600 font-medium">Total de Servicios</div>
                                        <div class="text-2xl font-bold text-indigo-700">${allSpecialServices.length}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-indigo-600 font-medium">Total Acumulado</div>
                                        <div class="text-2xl font-bold text-indigo-700">${formatCurrency(totalSpecialServices)}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Services List -->
                            <div class="max-h-96 overflow-y-auto">
                                ${sortedServices.length === 0 ? `
                                    <div class="text-center py-8">
                                        <div class="text-gray-400 text-4xl mb-2"></div>
                                        <p class="text-gray-500">No hay servicios especiales registrados</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${sortedServices.map((service, index) => `
                                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                                <div class="flex justify-between items-start gap-4">
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <span class="text-lg">猸</span>
                                                            <span class="font-semibold text-gray-800">${service.detail || 'Sin detalle'}</span>
                                                        </div>
                                                        <div class="text-sm text-gray-600 space-y-1">
                                                            <div>
                                                                <span class="font-medium">Fecha:</span> ${getFormattedDate(service.date || service.createdAt)}
                                                            </div>
                                                            <div>
                                                                <span class="font-medium">Costo:</span> 
                                                                <span class="text-indigo-700 font-semibold">${formatCurrency(service.cost || 0)}</span>
                                                            </div>
                                                            ${service.createdByName ? `
                                                                <div>
                                                                    <span class="font-medium">Registrado por:</span> ${service.createdByName}
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                    <button
                                                        id="delete-special-service-${service.id || index}"
                                                        class="delete-special-service-btn flex-shrink-0 bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                                                        data-service-id="${service.id}"
                                                        data-service-detail="${(service.detail || 'Sin detalle').replace(/"/g, '&quot;')}"
                                                        title="Eliminar servicio"
                                                    >
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                            
                            <!-- Close Button -->
                            <div class="mt-6 flex justify-end">
                                <button
                                    id="close-special-services-history-modal-btn"
                                    class="bg-indigo-700 hover:bg-indigo-800 text-white px-6 py-2 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200"
                                >
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById(modalId);
            
            // Close modal function
            const closeModal = () => {
                modal.remove();
            };
            
            // Close handlers
            document.getElementById('close-special-services-history-modal').addEventListener('click', closeModal);
            document.getElementById('close-special-services-history-modal-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            // Delete button handlers
            const deleteButtons = modal.querySelectorAll('.delete-special-service-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const serviceId = button.getAttribute('data-service-id');
                    const serviceDetail = button.getAttribute('data-service-detail');
                    
                    if (!serviceId) {
                        showModal('message', 'Error: No se pudo identificar el servicio a eliminar.');
                        return;
                    }
                    
                    const confirmMessage = `驴Est谩s seguro de que deseas eliminar este servicio especial?\n\nDetalle: ${serviceDetail}\n\nEsta acci贸n no se puede deshacer.`;
                    
                    showModal('confirm', confirmMessage, async () => {
                        try {
                            // Disable button during deletion
                            button.disabled = true;
                            button.classList.add('opacity-50', 'cursor-not-allowed');
                            
                            // Delete from Firebase
                            await deleteFromFirebase('specialServices', serviceId);
                            
                            // Reload all transactions
                            await loadAllTransactions();
                            
                            // Close and reopen modal to refresh the list
                            closeModal();
                            showSpecialServicesHistoryModal();
                            
                            showModal('message', ' Servicio especial eliminado exitosamente.');
                            
                            // Update dashboard
                            renderApp();
                        } catch (error) {
                            console.error('Error deleting special service:', error);
                            showModal('message', 'Error al eliminar el servicio especial. Por favor, intenta de nuevo.');
                            
                            // Re-enable button on error
                            button.disabled = false;
                            button.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    });
                });
            });
        }
        
        // Function to show register special service modal from dashboard
        function showRegisterSpecialServiceModal() {
            const modalId = 'register-special-service-modal-' + Date.now();
            const today = getTodayLocalDate();
            
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="overflow-y: auto; z-index: 1000;">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 my-8">
                        <div class="p-6">
                            <!-- Modal Header -->
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">猸 Registrar Servicio Especial</h2>
                                <button
                                    id="close-register-special-service-modal"
                                    class="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                                    style="background: none; border: none; cursor: pointer; padding: 0.5rem;"
                                >
                                    
                                </button>
                            </div>
                            
                            <form id="register-special-service-form">
                                <!-- Service Date -->
                                <div class="mb-4">
                                    <label for="special-service-date" class="block text-sm font-medium text-gray-700 mb-2">
                                        Fecha del Servicio: <span class="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="date"
                                        id="special-service-date"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        value="${today}"
                                        required
                                    />
                                </div>
                                
                                <!-- Service Detail -->
                                <div class="mb-4">
                                    <label for="special-service-detail" class="block text-sm font-medium text-gray-700 mb-2">
                                        Detalle del Servicio: <span class="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        id="special-service-detail"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="Ej: Servicio de entrega urgente"
                                        required
                                    />
                                </div>
                                
                                <!-- Service Cost -->
                                <div class="mb-4">
                                    <label for="special-service-cost" class="block text-sm font-medium text-gray-700 mb-2">
                                        Costo del Servicio ($): <span class="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        id="special-service-cost"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 currency-input"
                                        placeholder="Ej: 25.000"
                                        required
                                    />
                                </div>
                                
                                <!-- Buttons -->
                                <div class="flex space-x-3">
                                    <button
                                        type="button"
                                        id="cancel-register-special-service"
                                        class="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg font-medium hover:bg-gray-400 transition duration-200"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        type="submit"
                                        id="submit-register-special-service"
                                        class="flex-1 bg-indigo-700 hover:bg-indigo-800 text-white px-4 py-3 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200"
                                    >
                                        Registrar Servicio Especial
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById(modalId);
            
            // Close modal function
            const closeModal = () => {
                modal.remove();
            };
            
            // Close handlers
            document.getElementById('close-register-special-service-modal').addEventListener('click', closeModal);
            document.getElementById('cancel-register-special-service').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            // Format cost input
            const costInput = document.getElementById('special-service-cost');
            if (costInput) {
                costInput.addEventListener('input', () => formatNumberInput(costInput));
                costInput.addEventListener('blur', () => formatNumberInput(costInput));
            }
            
            // Form submission
            const form = document.getElementById('register-special-service-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const serviceDate = document.getElementById('special-service-date').value;
                const detail = document.getElementById('special-service-detail').value.trim();
                const cost = getNumericValue(costInput.value);
                
                if (!detail) {
                    showModal('message', 'Por favor, ingresa el detalle del servicio.');
                    return;
                }
                
                if (isNaN(cost) || cost <= 0) {
                    showModal('message', 'Por favor, ingresa un costo v谩lido para el servicio.');
                    return;
                }
                
                // Show confirmation
                const [year, month, day] = serviceDate.split('-');
                const displayDate = new Date(year, month - 1, day).toLocaleDateString('es-CO');
                const confirmMessage = `驴Confirmar registro del servicio especial?\n\nFecha: ${displayDate}\nDetalle: ${detail}\nCosto: ${formatCurrency(cost)}`;
                
                showModal('confirm', confirmMessage, async () => {
                    try {
                        // Save special service (no messengerId)
                        await saveSpecialService({
                            detail: detail,
                            cost: cost,
                            serviceDate: serviceDate
                        }, serviceDate);
                        
                        // Reload all transactions and update dashboard
                        await loadAllTransactions();
                        
                        closeModal();
                        showModal('message', ` Servicio especial registrado exitosamente.\n\nCosto: ${formatCurrency(cost)}`);
                        
                        renderApp();
                    } catch (error) {
                        console.error('Error registering special service:', error);
                        showModal('message', 'Error al registrar el servicio especial. Por favor, intenta de nuevo.');
                    }
                });
            });
        }

        // Function to save special service (not associated with any messenger)
        async function saveSpecialService(service, serviceDate) {
            try {
                await saveToFirebase('specialServices', {
                    detail: service.detail,
                    cost: service.cost,
                    createdBy: currentUser.uid,
                    createdByEmail: currentUser.email,
                    createdByName: currentUser.displayName || currentUser.email,
                    createdAt: new Date().toISOString(),
                    date: dateStringToISO(serviceDate)
                });
            } catch (error) {
                console.error('Error saving special service:', error);
                throw error;
            }
        }

        // Function to show register service modal from dashboard
        function showRegisterServiceModal() {
            if (messengers.length === 0) {
                showModal('message', 'No hay mensajeros registrados. Por favor, agrega un mensajero primero.');
                return;
            }

            const modalId = 'register-service-modal-' + Date.now();
            const today = getTodayLocalDate(); // Format: YYYY-MM-DD in local timezone
            
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="overflow-y: auto; z-index: 1000;">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 my-8">
                        <div class="p-6">
                            <!-- Modal Header -->
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">Registrar Servicio</h2>
                                <button
                                    id="close-register-service-modal"
                                    class="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                                    style="background: none; border: none; cursor: pointer; padding: 0.5rem;"
                                >
                                    
                                </button>
                            </div>
                            
                            <form id="register-service-form">
                                <!-- Messenger Selection -->
                                <div class="mb-4">
                                    <label for="service-messenger-select" class="block text-sm font-medium text-gray-700 mb-2">
                                        Mensajero: <span class="text-red-500">*</span>
                                    </label>
                                    <select
                                        id="service-messenger-select"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary"
                                        required
                                    >
                                        <option value="">-- Seleccionar Mensajero --</option>
                                        ${messengers.map(m => `
                                            <option value="${m.id}">${m.name}${m.phoneNumber ? ` - ${m.phoneNumber}` : ''}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <!-- Service Date -->
                                <div class="mb-4">
                                    <label for="service-date" class="block text-sm font-medium text-gray-700 mb-2">
                                        Fecha del Servicio: <span class="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="date"
                                        id="service-date"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary"
                                        value="${today}"
                                        required
                                    />
                                </div>
                                
                                <!-- Service Description -->
                                <div class="mb-4">
                                    <label for="service-description-new" class="block text-sm font-medium text-gray-700 mb-2">
                                        Descripci贸n del Servicio: <span class="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        id="service-description-new"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary"
                                        placeholder="Ej: Entrega de paquete A"
                                        required
                                    />
                                </div>
                                
                                <!-- Service Total Amount -->
                                <div class="mb-4">
                                    <label for="service-total-amount" class="block text-sm font-medium text-gray-700 mb-2">
                                        Valor Total del Servicio ($): <span class="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        id="service-total-amount"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary currency-input"
                                        placeholder="Ej: 10.000"
                                        required
                                    />
                                    <p class="text-xs text-gray-500 mt-1">Se descontar谩 el 20% de este valor del saldo del mensajero</p>
                                </div>
                                
                                <!-- Calculation Preview -->
                                <div id="service-calculation-preview" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                                    <h4 class="text-sm font-semibold text-blue-800 mb-2">Resumen del C谩lculo:</h4>
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-700">Valor Total del Servicio:</span>
                                            <span class="font-semibold" id="preview-total">$0</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-700">Porcentaje a descontar (20%):</span>
                                            <span class="font-semibold text-blue-600" id="preview-percentage">$0</span>
                                        </div>
                                        <div class="pt-2 border-t border-blue-200">
                                            <div class="flex justify-between">
                                                <span class="font-semibold text-gray-800">Monto a descontar del saldo:</span>
                                                <span class="font-bold text-lg text-red-600" id="preview-amount">$0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Buttons -->
                                <div class="flex space-x-3">
                                    <button
                                        type="button"
                                        id="cancel-register-service"
                                        class="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg font-medium hover:bg-gray-400 transition duration-200"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        type="submit"
                                        id="submit-register-service"
                                        class="flex-1 btn-llevo-secondary px-4 py-3 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-llevo-secondary focus:ring-offset-2 transition duration-200"
                                    >
                                        Registrar Servicio
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById(modalId);
            
            // Close modal function
            const closeModal = () => {
                modal.remove();
            };
            
            // Close handlers
            document.getElementById('close-register-service-modal').addEventListener('click', closeModal);
            document.getElementById('cancel-register-service').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            // Calculate and preview on amount change
            const totalAmountInput = document.getElementById('service-total-amount');
            const calculationPreview = document.getElementById('service-calculation-preview');
            const previewTotal = document.getElementById('preview-total');
            const previewPercentage = document.getElementById('preview-percentage');
            const previewAmount = document.getElementById('preview-amount');
            
            totalAmountInput.addEventListener('input', () => {
                formatNumberInput(totalAmountInput);
                updateServiceCalculation();
            });
            
            function updateServiceCalculation() {
                const totalValue = getNumericValue(totalAmountInput.value);
                if (totalValue > 0) {
                    const percentage = Math.round(totalValue * 0.20); // 20%
                    
                    previewTotal.textContent = formatCurrency(totalValue);
                    previewPercentage.textContent = formatCurrency(percentage);
                    previewAmount.textContent = formatCurrency(percentage);
                    
                    calculationPreview.classList.remove('hidden');
                } else {
                    calculationPreview.classList.add('hidden');
                }
            }
            
            // Form submission
            const form = document.getElementById('register-service-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const messengerId = document.getElementById('service-messenger-select').value;
                const serviceDate = document.getElementById('service-date').value;
                const description = document.getElementById('service-description-new').value.trim();
                const totalAmount = getNumericValue(totalAmountInput.value);
                
                if (!messengerId) {
                    showModal('message', 'Por favor, selecciona un mensajero.');
                    return;
                }
                
                if (!description) {
                    showModal('message', 'Por favor, ingresa una descripci贸n del servicio.');
                    return;
                }
                
                if (isNaN(totalAmount) || totalAmount <= 0) {
                    showModal('message', 'Por favor, ingresa un valor v谩lido para el servicio.');
                    return;
                }
                
                // Calculate 20%
                const amountToDeduct = Math.round(totalAmount * 0.20);
                
                // Show confirmation with calculation
                const messenger = messengers.find(m => m.id === messengerId);
                // Format date for display (serviceDate is YYYY-MM-DD)
                const [year, month, day] = serviceDate.split('-');
                const displayDate = new Date(year, month - 1, day).toLocaleDateString('es-CO');
                const confirmMessage = `驴Confirmar registro del servicio?\n\nMensajero: ${messenger.name}\nFecha: ${displayDate}\nDescripci贸n: ${description}\nValor Total: ${formatCurrency(totalAmount)}\nMonto a descontar (20%): ${formatCurrency(amountToDeduct)}`;
                
                showModal('confirm', confirmMessage, async () => {
                    try {
                        // Set selected messenger for the save function
                        selectedMessengerId = messengerId;
                        selectedMessenger = messenger;
                        
                        // Create service with the calculated amount (20%)
                        const newService = {
                            description: description,
                            amount: amountToDeduct,
                            totalAmount: totalAmount, // Store total amount for reference
                            serviceDate: serviceDate
                        };
                        
                        // Use the existing saveService function but with custom date
                        await saveServiceWithDate(newService, serviceDate);
                        
                        // Reload services for the selected messenger
                        await loadServices(selectedMessengerId);
                        
                        // Reload all transactions and update dashboard
                        await loadAllTransactions();
                        
                        // Calculate new balance
                        const newBalance = recalculateMessengerBalance(selectedMessengerId);
                        
                        closeModal();
                        showModal('message', ` Servicio registrado exitosamente.\n\nValor total: ${formatCurrency(totalAmount)}\nDescontado del saldo (20%): ${formatCurrency(amountToDeduct)}\nSaldo actual de ${messenger.name}: ${formatCurrency(newBalance)}`);
                        
                        // Reset selection
                        selectedMessengerId = '';
                        selectedMessenger = null;
                        servicesHistory = [];
                        topupsHistory = [];
                        
                        renderApp();
                    } catch (error) {
                        console.error('Error registering service:', error);
                        showModal('message', 'Error al registrar el servicio. Por favor, intenta de nuevo.');
                    }
                });
            });
        }

        // Function to attach form listeners in modal
        function attachFormListeners(modal) {
            const topupForm = modal.querySelector('#topup-form');
            if (topupForm) {
                topupForm.addEventListener('submit', handleAddTopup);
            }
            
            // Currency input formatters
            const topupAmountInput = modal.querySelector('#topup-amount');
            if (topupAmountInput) {
                topupAmountInput.addEventListener('input', () => formatNumberInput(topupAmountInput));
                topupAmountInput.addEventListener('blur', () => formatNumberInput(topupAmountInput));
            }
        }

        // --- Event Handlers ---
        const handleAddMessenger = () => {
            // Crear un modal personalizado para agregar mensajeros
            const modalId = 'add-messenger-modal-' + Date.now();
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 add-messenger-modal">
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center"> Agregar Nuevo Mensajero</h3>
                        
                        <form id="add-messenger-form">
                            <div class="mb-4">
                                <label for="messenger-name" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre del Mensajero:
                                </label>
                                <input
                                    type="text"
                                    id="messenger-name"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary"
                                    placeholder="Ej: Juan P茅rez"
                                    required
                                />
                            </div>
                            
                            <div class="mb-6">
                                <label for="messenger-phone" class="block text-sm font-medium text-gray-700 mb-2">
                                    N煤mero de Celular:
                                </label>
                                <input
                                    type="tel"
                                    id="messenger-phone"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-llevo-secondary"
                                    placeholder="Ej: 3001234567"
                                    maxlength="13"
                                    required
                                />
                                <p class="text-xs text-gray-500 mt-1">Formato: 10-13 d铆gitos</p>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button
                                    type="button"
                                    id="cancel-add-messenger"
                                    class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-400 transition duration-200"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    id="submit-add-messenger"
                                    class="flex-1 bg-llevo-secondary text-white px-4 py-2 rounded-lg font-medium hover:bg-llevo-secondary-hover transition duration-200"
                                >
                                    Agregar Mensajero
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Agregar el modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Obtener referencias a los elementos del modal
            const modal = document.getElementById(modalId);
            const form = document.getElementById('add-messenger-form');
            const nameInput = document.getElementById('messenger-name');
            const phoneInput = document.getElementById('messenger-phone');
            const cancelButton = document.getElementById('cancel-add-messenger');
            const submitButton = document.getElementById('submit-add-messenger');
            
            // Formatear n煤mero de tel茅fono mientras se escribe
            phoneInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0) {
                    // Formatear como n煤mero colombiano
                    if (value.length <= 3) {
                        value = value;
                    } else if (value.length <= 6) {
                        value = value.slice(0, 3) + ' ' + value.slice(3);
                    } else if (value.length <= 10) {
                        value = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6);
                    } else {
                        value = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6, 10) + ' ' + value.slice(10);
                    }
                }
                e.target.value = value;
                
                // Validar duplicados en tiempo real si el n煤mero tiene la longitud correcta
                const cleanValue = value.replace(/\s/g, '');
                if (cleanValue.length >= 10 && cleanValue.length <= 13) {
                    validatePhoneInRealTime(cleanValue);
                } else {
                    clearPhoneValidation();
                }
            });
            
            // Funci贸n para validar duplicados en tiempo real
            async function validatePhoneInRealTime(phoneNumber) {
                try {
                    const duplicateCheck = await checkPhoneNumberExists(phoneNumber);
                    if (duplicateCheck.exists) {
                        showPhoneValidationError(`锔 Este n煤mero ya est谩 registrado por: ${duplicateCheck.messenger.name}`);
                    } else {
                        showPhoneValidationSuccess(' N煤mero disponible');
                    }
                } catch (error) {
                    console.warn('Error en validaci贸n en tiempo real:', error);
                }
            }
            
            // Funci贸n para mostrar error de validaci贸n
            function showPhoneValidationError(message) {
                clearPhoneValidation();
                const errorDiv = document.createElement('div');
                errorDiv.id = 'phone-validation-error';
                errorDiv.className = 'text-red-600 text-sm mt-1 flex items-center';
                errorDiv.innerHTML = message;
                phoneInput.parentNode.appendChild(errorDiv);
                phoneInput.classList.add('border-red-500');
            }
            
            // Funci贸n para mostrar 茅xito de validaci贸n
            function showPhoneValidationSuccess(message) {
                clearPhoneValidation();
                const successDiv = document.createElement('div');
                successDiv.id = 'phone-validation-success';
                successDiv.className = 'text-green-600 text-sm mt-1 flex items-center';
                successDiv.innerHTML = message;
                phoneInput.parentNode.appendChild(successDiv);
                phoneInput.classList.add('border-green-500');
            }
            
            // Funci贸n para limpiar validaciones
            function clearPhoneValidation() {
                const errorDiv = document.getElementById('phone-validation-error');
                const successDiv = document.getElementById('phone-validation-success');
                if (errorDiv) errorDiv.remove();
                if (successDiv) successDiv.remove();
                phoneInput.classList.remove('border-red-500', 'border-green-500');
            }
            
            // Funci贸n para cerrar el modal de manera segura
            function closeModal() {
                // Limpiar formulario
                if (form) {
                    form.reset();
                }
                // Limpiar validaciones visuales
                clearPhoneValidation();
                
                // Agregar animaci贸n de salida
                if (modal) {
                    modal.style.opacity = '0';
                    modal.style.transform = 'scale(0.95)';
                    
                    // Remover despu茅s de la animaci贸n
                    setTimeout(() => {
                        if (modal && modal.parentNode) {
                            modal.remove();
                        }
                    }, 200);
                }
                
                // Limpiar event listeners
                document.removeEventListener('keydown', handleEscape);
            }
            
            // Manejar cancelaci贸n
            cancelButton.addEventListener('click', closeModal);
            
            // Manejar env铆o del formulario
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = nameInput.value.trim();
                const phone = phoneInput.value.trim();
                
                // Validaciones b谩sicas
                if (!name) {
                    alert('Por favor, ingresa el nombre del mensajero.');
                    nameInput.focus();
                    return;
                }
                
                if (!phone) {
                    alert('Por favor, ingresa el n煤mero de celular.');
                    phoneInput.focus();
                    return;
                }
                
                // Validar formato de celular
                const cleanPhone = phone.replace(/\s/g, '');
                if (cleanPhone.length < 10 || cleanPhone.length > 13) {
                    alert('El n煤mero de celular debe tener entre 10 y 13 d铆gitos.');
                    phoneInput.focus();
                    return;
                }
                
                // Deshabilitar bot贸n durante el proceso
                submitButton.disabled = true;
                submitButton.textContent = 'Verificando...';
                
                try {
                    // Verificar si el n煤mero de celular ya existe
                    submitButton.textContent = 'Verificando duplicados...';
                    const duplicateCheck = await checkPhoneNumberExists(cleanPhone);
                    
                    if (duplicateCheck.exists) {
                        const sourceText = duplicateCheck.source === 'local' ? 'en memoria local' : 'en la base de datos';
                        alert(`Ya existe un mensajero registrado con el n煤mero ${cleanPhone}.\n\nMensajero: ${duplicateCheck.messenger.name}\n\nFuente: ${sourceText}`);
                        phoneInput.focus();
                        submitButton.disabled = false;
                        submitButton.textContent = 'Agregar Mensajero';
                        return;
                    }
                    
                    // Cambiar texto del bot贸n para indicar que se est谩 guardando
                    submitButton.textContent = 'Guardando...';
                    
                    const newMessenger = {
                        name: name,
                        phoneNumber: cleanPhone,
                        balance: 0
                    };
                    
                    await saveMessenger(newMessenger);
                    messengers.push(newMessenger);
                    
                    // Cerrar modal y mostrar confirmaci贸n
                    closeModal();
                    
                    // Mostrar mensaje de 茅xito usando showModal
                    showModal('message', ` Mensajero '${name}' con celular ${cleanPhone} agregado con 茅xito a Firebase.`);
                    
                    // Reload messengers and transactions
                    await loadMessengers();
                    
                    // Actualizar la interfaz
                    renderApp();
                    
                } catch (error) {
                    console.error("Error adding messenger: ", error);
                    alert("Error al agregar el mensajero a Firebase. Por favor, intenta de nuevo.");
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Agregar Mensajero';
                }
            });
            
            // Enfocar el primer input
            nameInput.focus();
            
            // Cerrar modal con Escape
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            // Cerrar modal haciendo clic fuera de 茅l
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        };

        const handleDeleteMessenger = (messengerId, messengerName) => {
            showModal(
                'confirm',
                `驴Est谩s seguro de que quieres eliminar al mensajero '${messengerName}' y todos sus datos?`,
                async () => {
                    try {
                        // Remove from messengers array
                        messengers = messengers.filter(m => m.id !== messengerId);
                        
                        // Delete from Firebase
                        await deleteFromFirebase('messengers', messengerId);
                        
                        // Delete related services and topups from Firebase
                        const servicesToDelete = servicesHistory.filter(s => s.messengerId === messengerId);
                        const topupsToDelete = topupsHistory.filter(t => t.messengerId === messengerId);
                        
                        for (const service of servicesToDelete) {
                            await deleteFromFirebase('services', service.id);
                        }
                        
                        for (const topup of topupsToDelete) {
                            await deleteFromFirebase('topups', topup.id);
                        }

                        showModal('message', `Mensajero '${messengerName}' y todos sus datos eliminados de Firebase.`);
                        if (selectedMessengerId === messengerId) {
                            selectedMessengerId = '';
                            selectedMessenger = null;
                            servicesHistory = [];
                            topupsHistory = [];
                        }
                        // Reload messengers and transactions
                        await loadMessengers();
                        renderApp();
                    } catch (e) {
                        console.error("Error deleting messenger:", e);
                        showModal('message', "Error al eliminar el mensajero de Firebase.");
                    }
                }
            );
        };

        async function handleRegisterService(e) {
            e.preventDefault();
            
            // Prevent duplicate submissions
            if (isProcessing) {
                showModal('message', 'Ya se est谩 procesando una transacci贸n. Por favor, espere.');
                return;
            }
            
            isProcessing = true;
            setProcessingTimeout(); // Set safety timeout
            
            const serviceDescriptionInput = document.getElementById('service-description');
            const serviceAmountInput = document.getElementById('service-amount');

            if (!selectedMessengerId || !serviceDescriptionInput.value.trim() || !serviceAmountInput.value) {
                showModal('message', 'Por favor, complete todos los campos de servicio.');
                resetProcessingState();
                return;
            }

            const amount = getNumericValue(serviceAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showModal('message', 'El monto del servicio debe ser un n煤mero positivo.');
                resetProcessingState();
                return;
            }

            try {
                // Add service to Firebase first
                const newService = {
                    description: serviceDescriptionInput.value.trim(),
                    amount: amount
                };
                await saveService(newService);
                
                // Reload services to get the updated list
                await loadServices(selectedMessengerId);
                
                // Calculate new balance after reloading data
                const newBalance = recalculateMessengerBalance(selectedMessengerId);

                showModal('message', `Servicio registrado para ${selectedMessenger.name} en Firebase. Saldo actual: ${formatCurrency(newBalance)}.`);
                clearForms();
                
                // Reload all transactions and update dashboard
                await loadAllTransactions();
                
                // Reload services for the modal
                await loadServices(selectedMessengerId);
                
                // Reset processing state before rendering
                resetProcessingState();
                
                // Close modal and refresh dashboard
                const modal = document.querySelector('[id^="messenger-detail-modal-"]');
                if (modal) {
                    modal.remove();
                }
                renderApp();
            } catch (e) {
                console.error("Error registering service: ", e);
                showModal('message', "Error al registrar el servicio en Firebase.");
                resetProcessingState();
            }
        }

        async function handleAddTopup(e) {
            e.preventDefault();
            
            // Prevent duplicate submissions
            if (isProcessing) {
                showModal('message', 'Ya se est谩 procesando una transacci贸n. Por favor, espere.');
                return;
            }
            
            isProcessing = true;
            setProcessingTimeout(); // Set safety timeout
            
            const topupAmountInput = document.getElementById('topup-amount');

            if (!selectedMessengerId || !topupAmountInput.value) {
                showModal('message', 'Por favor, ingrese el monto de la recarga.');
                resetProcessingState();
                return;
            }

            const amount = getNumericValue(topupAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showModal('message', 'El monto de la recarga debe ser un n煤mero positivo.');
                resetProcessingState();
                return;
            }

            try {
                // Add topup to Firebase first
                const newTopup = {
                    amount: amount
                };
                await saveTopup(newTopup);
                
                // Reload topups to get the updated list
                await loadTopups(selectedMessengerId);
                
                // Calculate new balance after reloading data
                const newBalance = recalculateMessengerBalance(selectedMessengerId);

                showModal('message', `Recarga de ${formatCurrency(amount)} agregada para ${selectedMessenger.name} en Firebase. Saldo actual: ${formatCurrency(newBalance)}.`);
                clearForms();
                
                // Reload all transactions and update dashboard
                await loadAllTransactions();
                
                // Reload topups for the modal
                await loadTopups(selectedMessengerId);
                
                // Reset processing state before rendering
                resetProcessingState();
                
                // Close modal and refresh dashboard
                const modal = document.querySelector('[id^="messenger-detail-modal-"]');
                if (modal) {
                    modal.remove();
                }
                renderApp();
            } catch (e) {
                console.error("Error adding top-up: ", e);
                showModal('message', "Error al agregar la recarga en Firebase.");
                resetProcessingState();
            }
        }

        // --- Initialization ---
        window.onload = async function () {
            try {
                // Wait for Firebase to be ready
                let attempts = 0;
                while (!window.db && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.db) {
                    throw new Error('Firebase no se inicializ贸 correctamente');
                }
                
                // Set up authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Check if user is admin
                        if (ADMIN_USERS.includes(user.email)) {
                            currentUser = user;
                            await loadMessengers();
                        } else {
                            showModal('message', `Acceso denegado. El usuario ${user.email} no est谩 autorizado como administrador.`);
                            await signOut(auth);
                            currentUser = null;
                        }
                    } else {
                        currentUser = null;
                    }
                    
                    isInitialized = true;
                    renderApp();
                });
                
            } catch (error) {
                console.error("Error initializing application:", error);
                errorMessage = "Error al inicializar la aplicaci贸n con Firebase. Por favor, verifica tu configuraci贸n.";
                renderApp();
            }
        };
    </script>
</body>
</html>

